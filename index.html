<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sistem Kasir Rafa Medica (V25.13 - Professional Edition)</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: {
                            50: '#f0f9ff',
                            100: '#e0f2fe',
                            200: '#bae6fd',
                            300: '#7dd3fc',
                            400: '#38bdf8',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                            800: '#075985',
                            900: '#0c4a6e',
                            950: '#082f49'
                        },
                        accent: {
                            50: '#fdf4ff',
                            100: '#fae8ff',
                            200: '#f5d0fe',
                            300: '#f0abfc',
                            400: '#e879f9',
                            500: '#d946ef',
                            600: '#c026d3',
                            700: '#a21caf',
                            800: '#86198f',
                            900: '#701a75'
                        },
                        success: {
                            50: '#f0fdf4',
                            100: '#dcfce7',
                            500: '#22c55e',
                            600: '#16a34a',
                            700: '#15803d'
                        },
                        warning: {
                            50: '#fefce8',
                            100: '#fef9c3',
                            500: '#eab308',
                            600: '#ca8a04'
                        },
                        danger: {
                            50: '#fef2f2',
                            100: '#fee2e2',
                            500: '#ef4444',
                            600: '#dc2626'
                        },
                        neutral: {
                            50: '#f8fafc',
                            100: '#f1f5f9',
                            200: '#e2e8f0',
                            300: '#cbd5e1',
                            400: '#94a3b8',
                            500: '#64748b',
                            600: '#475569',
                            700: '#334155',
                            800: '#1e293b',
                            900: '#0f172a',
                            950: '#020617'
                        }
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', '-apple-system', 'sans-serif'],
                        mono: ['JetBrains Mono', 'Consolas', 'monospace']
                    },
                    boxShadow: {
                        'soft': '0 2px 8px rgba(0, 0, 0, 0.04), 0 1px 2px rgba(0, 0, 0, 0.06)',
                        'medium': '0 4px 16px rgba(0, 0, 0, 0.08), 0 2px 4px rgba(0, 0, 0, 0.06)',
                        'large': '0 8px 32px rgba(0, 0, 0, 0.12), 0 4px 8px rgba(0, 0, 0, 0.08)',
                        'glow-primary': '0 0 24px rgba(14, 165, 233, 0.15)',
                        'glow-success': '0 0 24px rgba(34, 197, 94, 0.15)'
                    },
                    borderRadius: {
                        'xl': '0.875rem',
                        '2xl': '1rem',
                        '3xl': '1.25rem'
                    }
                }
            }
        }
    </script>
    
    <!-- React & Dependencies -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- HTML2Canvas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <!-- Fonts & Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">

    <!-- Fuse.js -->
    <script src="https://cdn.jsdelivr.net/npm/fuse.js@7.0.0/dist/fuse.min.js"></script>

    <!-- Firebase SDK -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, serverTimestamp, writeBatch, query, orderBy, increment, limit, setDoc, getDoc, getDocs, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const userConfig = {
            apiKey: "AIzaSyC8jXOyogDu_HIXVfjaVX7RhIc6kXiHdLk",
            authDomain: "stok-barang-49c8e.firebaseapp.com",
            projectId: "stok-barang-49c8e",
            storageBucket: "stok-barang-49c8e.firebasestorage.app",
            messagingSenderId: "1029640155610",
            appId: "1:1029640155610:web:d7db44abf2c3843cd110e3",
            measurementId: "G-12KTXQNRPP"
        };

        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : userConfig;
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        window.__firebase = { app, auth, db, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, serverTimestamp, writeBatch, query, orderBy, increment, limit, setDoc, getDoc, getDocs, where, signInAnonymously, onAuthStateChanged, signInWithCustomToken };
    </script>

    <style>
        * { -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Inter', sans-serif; background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%); }
        
        .fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-8px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .slide-up { animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(24px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .scale-in { animation: scaleIn 0.2s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes scaleIn {
            from { opacity: 0; transform: scale(0.95); }
            to { opacity: 1; transform: scale(1); }
        }
        
        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #0ea5e9;
            box-shadow: 0 0 0 3px rgba(14, 165, 233, 0.1);
        }
        
        .stat-card {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.9) 0%, rgba(255, 255, 255, 0.7) 100%);
            backdrop-filter: blur(12px);
        }
        
        .glass-morphism {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
            box-shadow: 0 4px 16px rgba(14, 165, 233, 0.3);
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 24px rgba(14, 165, 233, 0.4);
        }
        
        .btn-primary:active {
            transform: translateY(0);
        }
        
        .sidebar-menu-item {
            position: relative;
            transition: all 0.3s ease;
        }
        
        .sidebar-menu-item:hover {
            transform: translateX(4px);
        }
        
        .sidebar-menu-item.active::before {
            content: '';
            position: absolute;
            left: 0;
            top: 50%;
            transform: translateY(-50%);
            width: 4px;
            height: 70%;
            background: linear-gradient(180deg, #0ea5e9 0%, #0284c7 100%);
            border-radius: 0 4px 4px 0;
        }
        
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
            transition: background 0.2s;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
        
        .table-header {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border-bottom: 2px solid #e2e8f0;
        }
        
        .table-row {
            transition: all 0.2s ease;
        }
        
        .table-row:hover {
            background-color: #f8fafc;
            transform: scale(1.01);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }
        
        .badge {
            font-size: 0.75rem;
            font-weight: 600;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
        }
        
        .card-hover {
            transition: all 0.3s ease;
        }
        
        .card-hover:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 32px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="bg-gradient-to-br from-neutral-50 to-neutral-100 min-h-screen">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const { app, auth, db, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot, serverTimestamp, writeBatch, query, orderBy, increment, limit, setDoc, getDoc, getDocs, where, signInAnonymously, onAuthStateChanged, signInWithCustomToken } = window.__firebase;

        const APP_NAME = "Rafa Medica";
        
        const Icon = ({ name, className = '' }) => <i className={`fa-solid fa-${name} ${className}`}></i>;

        const Toast = ({ message, type = 'success', onClose }) => {
            useEffect(() => {
                const timer = setTimeout(onClose, 3000);
                return () => clearTimeout(timer);
            }, []);
            
            const bgColor = type === 'success' ? 'bg-success-500' : type === 'error' ? 'bg-danger-500' : 'bg-primary-500';
            const icon = type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle';
            
            return (
                <div className="fixed top-4 right-4 z-[999] slide-up">
                    <div className={`${bgColor} text-white px-6 py-4 rounded-2xl shadow-large flex items-center gap-3 min-w-[300px]`}>
                        <Icon name={icon} className="text-xl" />
                        <span className="font-medium">{message}</span>
                    </div>
                </div>
            );
        };

        const ConfirmModal = ({ isOpen, title, message, onConfirm, onCancel, confirmText = 'Hapus', cancelText = 'Batal', danger = true }) => {
            if (!isOpen) return null;
            return (
                <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-neutral-900/40 backdrop-blur-sm fade-in" onClick={onCancel}>
                    <div className="bg-white rounded-3xl shadow-large max-w-md w-full p-8 scale-in" onClick={e => e.stopPropagation()}>
                        <div className="text-center mb-6">
                            <div className={`w-16 h-16 ${danger ? 'bg-danger-100' : 'bg-primary-100'} rounded-2xl flex items-center justify-center mx-auto mb-4`}>
                                <Icon name={danger ? 'trash-alt' : 'question-circle'} className={`text-3xl ${danger ? 'text-danger-500' : 'text-primary-500'}`} />
                            </div>
                            <h3 className="text-2xl font-bold text-neutral-800 mb-2">{title}</h3>
                            <p className="text-neutral-600 leading-relaxed">{message}</p>
                        </div>
                        <div className="flex gap-3">
                            <button onClick={onCancel} className="flex-1 bg-neutral-100 hover:bg-neutral-200 text-neutral-700 font-semibold py-3.5 px-6 rounded-xl transition-all">
                                {cancelText}
                            </button>
                            <button onClick={() => { onConfirm(); onCancel(); }} className={`flex-1 ${danger ? 'bg-danger-500 hover:bg-danger-600' : 'bg-primary-500 hover:bg-primary-600'} text-white font-semibold py-3.5 px-6 rounded-xl shadow-medium transition-all hover:shadow-large`}>
                                {confirmText}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const NotificationsModal = ({ isOpen, onClose, activities = [] }) => {
            if (!isOpen) return null;
            
            const getActivityIcon = (type) => {
                switch(type) {
                    case 'sale': return { icon: 'shopping-cart', color: 'text-primary-500', bg: 'bg-primary-100' };
                    case 'purchase': return { icon: 'box', color: 'text-success-500', bg: 'bg-success-100' };
                    case 'transfer': return { icon: 'exchange-alt', color: 'text-warning-500', bg: 'bg-warning-100' };
                    case 'expense': return { icon: 'money-bill', color: 'text-danger-500', bg: 'bg-danger-100' };
                    default: return { icon: 'bell', color: 'text-neutral-500', bg: 'bg-neutral-100' };
                }
            };
            
            return (
                <div className="fixed inset-0 z-[100] flex items-end md:items-center justify-center p-0 md:p-4 bg-neutral-900/40 backdrop-blur-sm fade-in" onClick={onClose}>
                    <div className="bg-white rounded-t-3xl md:rounded-3xl shadow-large w-full md:max-w-2xl max-h-[85vh] flex flex-col scale-in" onClick={e => e.stopPropagation()}>
                        <div className="px-6 py-5 border-b border-neutral-200 flex items-center justify-between">
                            <div className="flex items-center gap-3">
                                <div className="w-10 h-10 bg-primary-100 rounded-xl flex items-center justify-center">
                                    <Icon name="bell" className="text-primary-500 text-lg" />
                                </div>
                                <div>
                                    <h3 className="text-xl font-bold text-neutral-800">Aktivitas Terbaru</h3>
                                    <p className="text-sm text-neutral-500">Riwayat transaksi hari ini</p>
                                </div>
                            </div>
                            <button onClick={onClose} className="w-10 h-10 bg-neutral-100 hover:bg-neutral-200 rounded-xl flex items-center justify-center transition-colors">
                                <Icon name="xmark" className="text-neutral-600 text-lg" />
                            </button>
                        </div>
                        <div className="flex-1 overflow-y-auto p-6">
                            {activities.length === 0 ? (
                                <div className="text-center py-12">
                                    <div className="w-20 h-20 bg-neutral-100 rounded-2xl flex items-center justify-center mx-auto mb-4">
                                        <Icon name="inbox" className="text-4xl text-neutral-400" />
                                    </div>
                                    <p className="text-neutral-500 font-medium">Belum ada aktivitas</p>
                                </div>
                            ) : (
                                <div className="space-y-3">
                                    {activities.map((activity, index) => {
                                        const iconData = getActivityIcon(activity.type);
                                        return (
                                            <div key={index} className="bg-neutral-50 rounded-2xl p-4 hover:bg-neutral-100 transition-all card-hover">
                                                <div className="flex items-start gap-4">
                                                    <div className={`w-12 h-12 ${iconData.bg} rounded-xl flex items-center justify-center flex-shrink-0`}>
                                                        <Icon name={iconData.icon} className={`${iconData.color} text-lg`} />
                                                    </div>
                                                    <div className="flex-1 min-w-0">
                                                        <p className="font-semibold text-neutral-800 mb-1">{activity.title}</p>
                                                        <p className="text-sm text-neutral-600 mb-2">{activity.description}</p>
                                                        <div className="flex items-center gap-2 text-xs text-neutral-500">
                                                            <Icon name="clock" />
                                                            <span>{activity.time}</span>
                                                        </div>
                                                    </div>
                                                    {activity.amount && (
                                                        <div className={`font-bold ${activity.type === 'expense' ? 'text-danger-500' : 'text-success-500'} whitespace-nowrap`}>
                                                            {activity.type === 'expense' ? '-' : '+'} Rp {activity.amount.toLocaleString('id-ID')}
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                        );
                                    })}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const DashboardView = ({ items, settings, onShowLowStock }) => {
            const totalItems = items.length;
            const totalValue = items.reduce((sum, item) => sum + (parseInt(item.qty) || 0) * (parseFloat(item.price) || 0), 0);
            const lowStockItems = items.filter(item => {
                const minStock = parseInt(item.minStock) || parseInt(settings.minStockDefault) || 0;
                return parseInt(item.qty) <= minStock && minStock > 0;
            });
            const outOfStock = items.filter(item => parseInt(item.qty) === 0).length;
            
            const stats = [
                { icon: 'box', label: 'Total Item', value: totalItems, color: 'primary', bgGradient: 'from-primary-500 to-primary-600' },
                { icon: 'coins', label: 'Nilai Inventory', value: `Rp ${totalValue.toLocaleString('id-ID')}`, color: 'success', bgGradient: 'from-success-500 to-success-600' },
                { icon: 'exclamation-triangle', label: 'Stok Menipis', value: lowStockItems.length, color: 'warning', bgGradient: 'from-warning-500 to-warning-600' },
                { icon: 'ban', label: 'Habis', value: outOfStock, color: 'danger', bgGradient: 'from-danger-500 to-danger-600' }
            ];
            
            return (
                <div className="space-y-6">
                    <div className="mb-8">
                        <h1 className="text-3xl font-black text-neutral-800 mb-2">Dashboard</h1>
                        <p className="text-neutral-600">Ringkasan inventory dan statistik toko Anda</p>
                    </div>
                    
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        {stats.map((stat, index) => (
                            <div key={index} className={`stat-card rounded-3xl p-6 shadow-medium hover:shadow-large transition-all card-hover border border-${stat.color}-100`}>
                                <div className="flex items-start justify-between mb-4">
                                    <div className={`w-14 h-14 bg-gradient-to-br ${stat.bgGradient} rounded-2xl flex items-center justify-center shadow-medium`}>
                                        <Icon name={stat.icon} className="text-white text-2xl" />
                                    </div>
                                </div>
                                <div>
                                    <p className="text-sm font-semibold text-neutral-600 mb-1 uppercase tracking-wider">{stat.label}</p>
                                    <p className="text-3xl font-black text-neutral-800">{stat.value}</p>
                                </div>
                            </div>
                        ))}
                    </div>
                    
                    {lowStockItems.length > 0 && (
                        <div className="bg-gradient-to-br from-warning-50 to-warning-100 rounded-3xl p-6 shadow-medium border-2 border-warning-200">
                            <div className="flex items-center justify-between mb-4">
                                <div className="flex items-center gap-3">
                                    <div className="w-12 h-12 bg-warning-500 rounded-xl flex items-center justify-center shadow-medium">
                                        <Icon name="exclamation-triangle" className="text-white text-xl" />
                                    </div>
                                    <div>
                                        <h3 className="text-xl font-bold text-neutral-800">Perhatian: Stok Menipis</h3>
                                        <p className="text-sm text-neutral-600">{lowStockItems.length} item memerlukan restock</p>
                                    </div>
                                </div>
                                <button onClick={onShowLowStock} className="bg-white hover:bg-warning-500 hover:text-white text-warning-600 font-semibold px-6 py-3 rounded-xl transition-all shadow-soft">
                                    Lihat Detail
                                </button>
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 mt-4">
                                {lowStockItems.slice(0, 6).map((item, index) => (
                                    <div key={index} className="bg-white rounded-xl p-4 shadow-soft">
                                        <p className="font-bold text-neutral-800 mb-1 truncate">{item.name}</p>
                                        <div className="flex items-center justify-between">
                                            <span className="text-sm text-neutral-600">Sisa: <span className="font-bold text-danger-500">{item.qty}</span></span>
                                            <span className="badge bg-danger-100 text-danger-600">
                                                <Icon name="arrow-down" className="text-xs" />
                                                Low Stock
                                            </span>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    )}
                    
                    <div className="bg-white rounded-3xl p-6 shadow-medium">
                        <h3 className="text-xl font-bold text-neutral-800 mb-4">Petunjuk Penggunaan</h3>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div className="flex items-start gap-4 p-4 bg-neutral-50 rounded-2xl">
                                <div className="w-10 h-10 bg-primary-100 rounded-xl flex items-center justify-center flex-shrink-0">
                                    <Icon name="shopping-cart" className="text-primary-500" />
                                </div>
                                <div>
                                    <p className="font-semibold text-neutral-800 mb-1">Kasir</p>
                                    <p className="text-sm text-neutral-600">Kelola transaksi penjualan dengan cepat dan mudah</p>
                                </div>
                            </div>
                            <div className="flex items-start gap-4 p-4 bg-neutral-50 rounded-2xl">
                                <div className="w-10 h-10 bg-success-100 rounded-xl flex items-center justify-center flex-shrink-0">
                                    <Icon name="list" className="text-success-500" />
                                </div>
                                <div>
                                    <p className="font-semibold text-neutral-800 mb-1">Daftar Barang</p>
                                    <p className="text-sm text-neutral-600">Lihat dan kelola semua inventory Anda</p>
                                </div>
                            </div>
                            <div className="flex items-start gap-4 p-4 bg-neutral-50 rounded-2xl">
                                <div className="w-10 h-10 bg-warning-100 rounded-xl flex items-center justify-center flex-shrink-0">
                                    <Icon name="plus" className="text-warning-500" />
                                </div>
                                <div>
                                    <p className="font-semibold text-neutral-800 mb-1">Tambah Barang</p>
                                    <p className="text-sm text-neutral-600">Input barang baru ke sistem inventory</p>
                                </div>
                            </div>
                            <div className="flex items-start gap-4 p-4 bg-neutral-50 rounded-2xl">
                                <div className="w-10 h-10 bg-danger-100 rounded-xl flex items-center justify-center flex-shrink-0">
                                    <Icon name="history" className="text-danger-500" />
                                </div>
                                <div>
                                    <p className="font-semibold text-neutral-800 mb-1">Riwayat</p>
                                    <p className="text-sm text-neutral-600">Lihat semua transaksi dan aktivitas</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const CashierView = ({ items, user, showToast, settings, onGenerateImage, currentProfile }) => {
            const [cart, setCart] = useState([]);
            const [searchQuery, setSearchQuery] = useState('');
            const [paymentAmount, setPaymentAmount] = useState('');
            const [customerName, setCustomerName] = useState('');
            const [showReceipt, setShowReceipt] = useState(false);
            const [lastReceipt, setLastReceipt] = useState(null);
            const [showPayment, setShowPayment] = useState(false);
            
            const filteredItems = items.filter(item => 
                item.name.toLowerCase().includes(searchQuery.toLowerCase()) &&
                parseInt(item.qty) > 0
            );
            
            const addToCart = (item) => {
                const existing = cart.find(c => c.id === item.id);
                if (existing) {
                    if (existing.qtyCart >= parseInt(item.qty)) {
                        showToast('Stok tidak cukup!', 'error');
                        return;
                    }
                    setCart(cart.map(c => c.id === item.id ? {...c, qtyCart: c.qtyCart + 1} : c));
                } else {
                    setCart([...cart, {...item, qtyCart: 1}]);
                }
                showToast(`${item.name} ditambahkan ke keranjang`, 'success');
            };
            
            const updateCartQty = (id, newQty) => {
                const item = cart.find(c => c.id === id);
                if (newQty > parseInt(item.qty)) {
                    showToast('Stok tidak cukup!', 'error');
                    return;
                }
                if (newQty <= 0) {
                    setCart(cart.filter(c => c.id !== id));
                } else {
                    setCart(cart.map(c => c.id === id ? {...c, qtyCart: newQty} : c));
                }
            };
            
            const total = cart.reduce((sum, item) => sum + (parseFloat(item.price) * item.qtyCart), 0);
            const change = parseInt(paymentAmount) - total;
            
            const handleCheckout = async () => {
                if (cart.length === 0) {
                    showToast('Keranjang kosong!', 'error');
                    return;
                }
                setShowPayment(true);
            };
            
            const handlePayment = async () => {
                if (!paymentAmount || parseInt(paymentAmount) < total) {
                    showToast('Pembayaran tidak cukup!', 'error');
                    return;
                }
                
                try {
                    const batch = writeBatch(db);
                    const saleData = {
                        items: cart.map(item => ({
                            id: item.id,
                            name: item.name,
                            price: parseFloat(item.price),
                            qty: item.qtyCart,
                            subtotal: parseFloat(item.price) * item.qtyCart
                        })),
                        total: total,
                        payment: parseInt(paymentAmount),
                        change: change,
                        customer: customerName || 'Umum',
                        timestamp: serverTimestamp(),
                        uid: user.uid,
                        storeId: currentProfile.id
                    };
                    
                    await addDoc(collection(db, 'sales'), saleData);
                    
                    for (let item of cart) {
                        const itemRef = doc(db, 'items', item.id);
                        batch.update(itemRef, { qty: (parseInt(item.qty) - item.qtyCart).toString() });
                    }
                    
                    await batch.commit();
                    
                    setLastReceipt({...saleData, receiptNumber: Date.now().toString().slice(-8)});
                    setShowReceipt(true);
                    setShowPayment(false);
                    setCart([]);
                    setPaymentAmount('');
                    setCustomerName('');
                    showToast('Transaksi berhasil!', 'success');
                } catch (error) {
                    showToast('Gagal memproses transaksi', 'error');
                }
            };
            
            return (
                <div className="space-y-6">
                    <div className="mb-8">
                        <h1 className="text-3xl font-black text-neutral-800 mb-2">Kasir</h1>
                        <p className="text-neutral-600">Proses transaksi penjualan dengan cepat</p>
                    </div>
                    
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        <div className="lg:col-span-2 space-y-4">
                            <div className="bg-white rounded-3xl p-6 shadow-medium">
                                <div className="relative mb-6">
                                    <Icon name="search" className="absolute left-4 top-1/2 -translate-y-1/2 text-neutral-400" />
                                    <input
                                        type="text"
                                        placeholder="Cari barang..."
                                        value={searchQuery}
                                        onChange={(e) => setSearchQuery(e.target.value)}
                                        className="w-full pl-12 pr-4 py-4 bg-neutral-50 border-2 border-neutral-200 rounded-2xl font-medium text-neutral-800 focus:border-primary-500 transition-all"
                                    />
                                </div>
                                <div className="grid grid-cols-2 md:grid-cols-3 gap-4 max-h-[600px] overflow-y-auto pr-2">
                                    {filteredItems.map(item => (
                                        <button
                                            key={item.id}
                                            onClick={() => addToCart(item)}
                                            className="bg-neutral-50 hover:bg-primary-50 rounded-2xl p-4 text-left transition-all card-hover border-2 border-transparent hover:border-primary-200"
                                        >
                                            <div className="flex items-center justify-between mb-3">
                                                <div className="w-10 h-10 bg-primary-100 rounded-xl flex items-center justify-center">
                                                    <Icon name="box" className="text-primary-500" />
                                                </div>
                                                <span className="badge bg-success-100 text-success-600">
                                                    Stok: {item.qty}
                                                </span>
                                            </div>
                                            <p className="font-bold text-neutral-800 mb-2 line-clamp-2">{item.name}</p>
                                            <p className="text-lg font-black text-primary-600">Rp {parseFloat(item.price).toLocaleString('id-ID')}</p>
                                        </button>
                                    ))}
                                </div>
                            </div>
                        </div>
                        
                        <div className="space-y-4">
                            <div className="bg-white rounded-3xl p-6 shadow-medium">
                                <h3 className="text-xl font-bold text-neutral-800 mb-4 flex items-center gap-2">
                                    <Icon name="shopping-cart" className="text-primary-500" />
                                    Keranjang
                                </h3>
                                {cart.length === 0 ? (
                                    <div className="text-center py-12">
                                        <div className="w-16 h-16 bg-neutral-100 rounded-2xl flex items-center justify-center mx-auto mb-4">
                                            <Icon name="shopping-cart" className="text-3xl text-neutral-400" />
                                        </div>
                                        <p className="text-neutral-500">Keranjang kosong</p>
                                    </div>
                                ) : (
                                    <div className="space-y-3 max-h-[400px] overflow-y-auto pr-2 mb-4">
                                        {cart.map(item => (
                                            <div key={item.id} className="bg-neutral-50 rounded-xl p-4">
                                                <div className="flex items-start justify-between mb-3">
                                                    <p className="font-bold text-neutral-800 flex-1 pr-2">{item.name}</p>
                                                    <button onClick={() => setCart(cart.filter(c => c.id !== item.id))} className="text-danger-500 hover:text-danger-600 p-1">
                                                        <Icon name="trash" />
                                                    </button>
                                                </div>
                                                <div className="flex items-center justify-between">
                                                    <div className="flex items-center gap-2 bg-white rounded-lg p-1">
                                                        <button onClick={() => updateCartQty(item.id, item.qtyCart - 1)} className="w-8 h-8 bg-neutral-100 hover:bg-neutral-200 rounded-lg flex items-center justify-center font-bold text-neutral-600 transition-colors">
                                                            -
                                                        </button>
                                                        <span className="w-12 text-center font-bold text-neutral-800">{item.qtyCart}</span>
                                                        <button onClick={() => updateCartQty(item.id, item.qtyCart + 1)} className="w-8 h-8 bg-primary-500 hover:bg-primary-600 rounded-lg flex items-center justify-center font-bold text-white transition-colors">
                                                            +
                                                        </button>
                                                    </div>
                                                    <p className="font-bold text-primary-600">Rp {(parseFloat(item.price) * item.qtyCart).toLocaleString('id-ID')}</p>
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                )}
                            </div>
                            
                            {cart.length > 0 && (
                                <div className="bg-gradient-to-br from-primary-500 to-primary-600 rounded-3xl p-6 shadow-large text-white">
                                    <div className="flex items-center justify-between mb-2">
                                        <span className="text-sm font-semibold opacity-90">Total</span>
                                        <span className="text-3xl font-black">Rp {total.toLocaleString('id-ID')}</span>
                                    </div>
                                    <button onClick={handleCheckout} className="w-full bg-white text-primary-600 font-bold py-4 rounded-xl mt-4 hover:shadow-glow-primary transition-all">
                                        <Icon name="cash-register" className="mr-2" />
                                        Bayar Sekarang
                                    </button>
                                </div>
                            )}
                        </div>
                    </div>
                    
                    {showPayment && (
                        <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-neutral-900/40 backdrop-blur-sm fade-in" onClick={() => setShowPayment(false)}>
                            <div className="bg-white rounded-3xl shadow-large max-w-md w-full p-8 scale-in" onClick={e => e.stopPropagation()}>
                                <h3 className="text-2xl font-bold text-neutral-800 mb-6 text-center">Pembayaran</h3>
                                <div className="space-y-4 mb-6">
                                    <div className="bg-neutral-50 rounded-2xl p-6 text-center">
                                        <p className="text-sm text-neutral-600 mb-2">Total Belanja</p>
                                        <p className="text-4xl font-black text-neutral-800">Rp {total.toLocaleString('id-ID')}</p>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-semibold text-neutral-700 mb-2">Nama Pelanggan (Opsional)</label>
                                        <input
                                            type="text"
                                            placeholder="Masukkan nama..."
                                            value={customerName}
                                            onChange={(e) => setCustomerName(e.target.value)}
                                            className="w-full px-4 py-3 bg-neutral-50 border-2 border-neutral-200 rounded-xl font-medium text-neutral-800 transition-all"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-semibold text-neutral-700 mb-2">Jumlah Bayar</label>
                                        <div className="relative">
                                            <span className="absolute left-4 top-1/2 -translate-y-1/2 text-neutral-500 font-semibold">Rp</span>
                                            <input
                                                type="number"
                                                placeholder="0"
                                                value={paymentAmount}
                                                onChange={(e) => setPaymentAmount(e.target.value)}
                                                className="w-full pl-12 pr-4 py-4 bg-neutral-50 border-2 border-neutral-200 rounded-xl font-bold text-xl text-neutral-800 transition-all"
                                            />
                                        </div>
                                        <div className="grid grid-cols-3 gap-2 mt-3">
                                            {[50000, 100000, 200000].map(amount => (
                                                <button key={amount} onClick={() => setPaymentAmount(amount.toString())} className="bg-neutral-100 hover:bg-primary-500 hover:text-white text-neutral-700 font-semibold py-2 rounded-lg transition-all text-sm">
                                                    {(amount/1000)}K
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                    {paymentAmount && (
                                        <div className={`rounded-2xl p-4 text-center ${change >= 0 ? 'bg-success-50 border-2 border-success-200' : 'bg-danger-50 border-2 border-danger-200'}`}>
                                            <p className="text-sm font-semibold mb-1">{change >= 0 ? 'Kembalian' : 'Kurang'}</p>
                                            <p className={`text-2xl font-black ${change >= 0 ? 'text-success-600' : 'text-danger-600'}`}>
                                                Rp {Math.abs(change).toLocaleString('id-ID')}
                                            </p>
                                        </div>
                                    )}
                                </div>
                                <div className="flex gap-3">
                                    <button onClick={() => setShowPayment(false)} className="flex-1 bg-neutral-100 hover:bg-neutral-200 text-neutral-700 font-semibold py-4 rounded-xl transition-all">
                                        Batal
                                    </button>
                                    <button onClick={handlePayment} disabled={!paymentAmount || change < 0} className="flex-1 btn-primary text-white font-bold py-4 rounded-xl disabled:opacity-50 disabled:cursor-not-allowed">
                                        <Icon name="check" className="mr-2" />
                                        Konfirmasi
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                    
                    {showReceipt && lastReceipt && (
                        <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-neutral-900/40 backdrop-blur-sm fade-in" onClick={() => setShowReceipt(false)}>
                            <div className="bg-white rounded-3xl shadow-large max-w-md w-full p-8 scale-in" onClick={e => e.stopPropagation()}>
                                <div className="text-center mb-6">
                                    <div className="w-20 h-20 bg-success-100 rounded-full flex items-center justify-center mx-auto mb-4">
                                        <Icon name="check" className="text-4xl text-success-500" />
                                    </div>
                                    <h3 className="text-2xl font-bold text-neutral-800 mb-2">Transaksi Berhasil!</h3>
                                    <p className="text-neutral-600">Pembayaran telah diterima</p>
                                </div>
                                <div className="bg-neutral-50 rounded-2xl p-6 mb-6 space-y-3">
                                    <div className="flex items-center justify-between pb-3 border-b border-neutral-200">
                                        <span className="text-neutral-600">No. Transaksi</span>
                                        <span className="font-bold text-neutral-800">#{lastReceipt.receiptNumber}</span>
                                    </div>
                                    <div className="flex items-center justify-between">
                                        <span className="text-neutral-600">Total</span>
                                        <span className="font-bold text-neutral-800">Rp {lastReceipt.total.toLocaleString('id-ID')}</span>
                                    </div>
                                    <div className="flex items-center justify-between">
                                        <span className="text-neutral-600">Bayar</span>
                                        <span className="font-bold text-neutral-800">Rp {lastReceipt.payment.toLocaleString('id-ID')}</span>
                                    </div>
                                    <div className="flex items-center justify-between pt-3 border-t border-neutral-200">
                                        <span className="text-neutral-600">Kembalian</span>
                                        <span className="font-bold text-success-600 text-xl">Rp {lastReceipt.change.toLocaleString('id-ID')}</span>
                                    </div>
                                </div>
                                <button onClick={() => setShowReceipt(false)} className="w-full btn-primary text-white font-bold py-4 rounded-xl">
                                    Selesai
                                </button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const TransferView = ({ items, settings, showToast, currentProfile, user }) => {
            const [selectedItem, setSelectedItem] = useState(null);
            const [fromStore, setFromStore] = useState('');
            const [toStore, setToStore] = useState('');
            const [transferQty, setTransferQty] = useState('');
            const [searchQuery, setSearchQuery] = useState('');
            const [note, setNote] = useState('');
            
            const storeProfiles = settings.storeProfiles || [];
            const filteredItems = items.filter(item => 
                item.name.toLowerCase().includes(searchQuery.toLowerCase())
            );
            
            const handleTransfer = async () => {
                if (!selectedItem || !fromStore || !toStore || !transferQty) {
                    showToast('Mohon lengkapi semua data', 'error');
                    return;
                }
                
                if (fromStore === toStore) {
                    showToast('Toko asal dan tujuan tidak boleh sama', 'error');
                    return;
                }
                
                const qty = parseInt(transferQty);
                const availableQty = parseInt(selectedItem.qty);
                
                if (qty <= 0 || qty > availableQty) {
                    showToast('Jumlah transfer tidak valid', 'error');
                    return;
                }
                
                try {
                    await addDoc(collection(db, 'transfers'), {
                        itemId: selectedItem.id,
                        itemName: selectedItem.name,
                        fromStore: fromStore,
                        toStore: toStore,
                        qty: qty,
                        note: note,
                        timestamp: serverTimestamp(),
                        uid: user.uid
                    });
                    
                    showToast('Transfer berhasil dicatat', 'success');
                    setSelectedItem(null);
                    setFromStore('');
                    setToStore('');
                    setTransferQty('');
                    setNote('');
                } catch (error) {
                    showToast('Gagal mencatat transfer', 'error');
                }
            };
            
            return (
                <div className="space-y-6">
                    <div className="mb-8">
                        <h1 className="text-3xl font-black text-neutral-800 mb-2">Transfer Antar Toko</h1>
                        <p className="text-neutral-600">Kelola perpindahan barang antar cabang</p>
                    </div>
                    
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div className="bg-white rounded-3xl p-6 shadow-medium">
                            <h3 className="text-xl font-bold text-neutral-800 mb-4">Pilih Barang</h3>
                            <div className="relative mb-4">
                                <Icon name="search" className="absolute left-4 top-1/2 -translate-y-1/2 text-neutral-400" />
                                <input
                                    type="text"
                                    placeholder="Cari barang..."
                                    value={searchQuery}
                                    onChange={(e) => setSearchQuery(e.target.value)}
                                    className="w-full pl-12 pr-4 py-3 bg-neutral-50 border-2 border-neutral-200 rounded-xl font-medium text-neutral-800 transition-all"
                                />
                            </div>
                            <div className="space-y-2 max-h-[500px] overflow-y-auto pr-2">
                                {filteredItems.map(item => (
                                    <button
                                        key={item.id}
                                        onClick={() => setSelectedItem(item)}
                                        className={`w-full text-left p-4 rounded-xl transition-all ${selectedItem?.id === item.id ? 'bg-primary-100 border-2 border-primary-500' : 'bg-neutral-50 hover:bg-neutral-100 border-2 border-transparent'}`}
                                    >
                                        <div className="flex items-center justify-between">
                                            <div>
                                                <p className="font-bold text-neutral-800 mb-1">{item.name}</p>
                                                <p className="text-sm text-neutral-600">Stok: {item.qty} {item.unit}</p>
                                            </div>
                                            {selectedItem?.id === item.id && (
                                                <Icon name="check-circle" className="text-xl text-primary-500" />
                                            )}
                                        </div>
                                    </button>
                                ))}
                            </div>
                        </div>
                        
                        <div className="bg-white rounded-3xl p-6 shadow-medium">
                            <h3 className="text-xl font-bold text-neutral-800 mb-6">Detail Transfer</h3>
                            {!selectedItem ? (
                                <div className="text-center py-12">
                                    <div className="w-16 h-16 bg-neutral-100 rounded-2xl flex items-center justify-center mx-auto mb-4">
                                        <Icon name="box" className="text-3xl text-neutral-400" />
                                    </div>
                                    <p className="text-neutral-500">Pilih barang terlebih dahulu</p>
                                </div>
                            ) : (
                                <div className="space-y-4">
                                    <div className="bg-primary-50 rounded-2xl p-4 border-2 border-primary-200">
                                        <p className="text-sm font-semibold text-primary-600 mb-1">Barang Terpilih</p>
                                        <p className="font-bold text-neutral-800 text-lg">{selectedItem.name}</p>
                                        <p className="text-sm text-neutral-600 mt-1">Stok tersedia: {selectedItem.qty} {selectedItem.unit}</p>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-semibold text-neutral-700 mb-2">Dari Toko</label>
                                        <select value={fromStore} onChange={(e) => setFromStore(e.target.value)} className="w-full px-4 py-3 bg-neutral-50 border-2 border-neutral-200 rounded-xl font-medium text-neutral-800 transition-all">
                                            <option value="">Pilih toko asal</option>
                                            {storeProfiles.map(store => (
                                                <option key={store.id} value={store.id}>{store.name}</option>
                                            ))}
                                        </select>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-semibold text-neutral-700 mb-2">Ke Toko</label>
                                        <select value={toStore} onChange={(e) => setToStore(e.target.value)} className="w-full px-4 py-3 bg-neutral-50 border-2 border-neutral-200 rounded-xl font-medium text-neutral-800 transition-all">
                                            <option value="">Pilih toko tujuan</option>
                                            {storeProfiles.map(store => (
                                                <option key={store.id} value={store.id}>{store.name}</option>
                                            ))}
                                        </select>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-semibold text-neutral-700 mb-2">Jumlah Transfer</label>
                                        <input
                                            type="number"
                                            placeholder="0"
                                            value={transferQty}
                                            onChange={(e) => setTransferQty(e.target.value)}
                                            className="w-full px-4 py-3 bg-neutral-50 border-2 border-neutral-200 rounded-xl font-medium text-neutral-800 transition-all"
                                        />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-semibold text-neutral-700 mb-2">Catatan (Opsional)</label>
                                        <textarea
                                            placeholder="Tambahkan catatan..."
                                            value={note}
                                            onChange={(e) => setNote(e.target.value)}
                                            rows="3"
                                            className="w-full px-4 py-3 bg-neutral-50 border-2 border-neutral-200 rounded-xl font-medium text-neutral-800 transition-all resize-none"
                                        ></textarea>
                                    </div>
                                    <button onClick={handleTransfer} className="w-full btn-primary text-white font-bold py-4 rounded-xl">
                                        <Icon name="exchange-alt" className="mr-2" />
                                        Proses Transfer
                                    </button>
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            );
        };

        const HistoryView = ({ user, showToast, settings, onGenerateImage, currentProfile }) => {
            const [salesHistory, setSalesHistory] = useState([]);
            const [loading, setLoading] = useState(true);
            const [filter, setFilter] = useState('all');
            
            useEffect(() => {
                if (!user) return;
                const q = query(
                    collection(db, 'sales'),
                    where('uid', '==', user.uid),
                    orderBy('timestamp', 'desc'),
                    limit(100)
                );
                
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const sales = [];
                    snapshot.forEach(doc => {
                        sales.push({ id: doc.id, ...doc.data() });
                    });
                    setSalesHistory(sales);
                    setLoading(false);
                });
                
                return () => unsubscribe();
            }, [user]);
            
            const formatDate = (timestamp) => {
                if (!timestamp) return '-';
                const date = timestamp.toDate();
                return new Intl.DateTimeFormat('id-ID', {
                    dateStyle: 'medium',
                    timeStyle: 'short'
                }).format(date);
            };
            
            const totalSales = salesHistory.reduce((sum, sale) => sum + (sale.total || 0), 0);
            const todaySales = salesHistory.filter(sale => {
                if (!sale.timestamp) return false;
                const date = sale.timestamp.toDate();
                const today = new Date();
                return date.toDateString() === today.toDateString();
            });
            const todayTotal = todaySales.reduce((sum, sale) => sum + (sale.total || 0), 0);
            
            return (
                <div className="space-y-6">
                    <div className="mb-8">
                        <h1 className="text-3xl font-black text-neutral-800 mb-2">Riwayat Penjualan</h1>
                        <p className="text-neutral-600">Lihat dan kelola semua transaksi penjualan</p>
                    </div>
                    
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div className="stat-card rounded-3xl p-6 shadow-medium border border-primary-100">
                            <div className="flex items-start justify-between mb-4">
                                <div className="w-14 h-14 bg-gradient-to-br from-primary-500 to-primary-600 rounded-2xl flex items-center justify-center shadow-medium">
                                    <Icon name="history" className="text-white text-2xl" />
                                </div>
                            </div>
                            <p className="text-sm font-semibold text-neutral-600 mb-1 uppercase tracking-wider">Total Transaksi</p>
                            <p className="text-3xl font-black text-neutral-800">{salesHistory.length}</p>
                        </div>
                        <div className="stat-card rounded-3xl p-6 shadow-medium border border-success-100">
                            <div className="flex items-start justify-between mb-4">
                                <div className="w-14 h-14 bg-gradient-to-br from-success-500 to-success-600 rounded-2xl flex items-center justify-center shadow-medium">
                                    <Icon name="calendar-day" className="text-white text-2xl" />
                                </div>
                            </div>
                            <p className="text-sm font-semibold text-neutral-600 mb-1 uppercase tracking-wider">Hari Ini</p>
                            <p className="text-3xl font-black text-neutral-800">{todaySales.length}</p>
                        </div>
                        <div className="stat-card rounded-3xl p-6 shadow-medium border border-warning-100">
                            <div className="flex items-start justify-between mb-4">
                                <div className="w-14 h-14 bg-gradient-to-br from-warning-500 to-warning-600 rounded-2xl flex items-center justify-center shadow-medium">
                                    <Icon name="coins" className="text-white text-2xl" />
                                </div>
                            </div>
                            <p className="text-sm font-semibold text-neutral-600 mb-1 uppercase tracking-wider">Pendapatan Hari Ini</p>
                            <p className="text-3xl font-black text-neutral-800">Rp {todayTotal.toLocaleString('id-ID')}</p>
                        </div>
                    </div>
                    
                    <div className="bg-white rounded-3xl p-6 shadow-medium">
                        <div className="flex items-center justify-between mb-6">
                            <h3 className="text-xl font-bold text-neutral-800">Daftar Transaksi</h3>
                            <div className="flex gap-2">
                                <button onClick={() => setFilter('all')} className={`px-4 py-2 rounded-xl font-semibold transition-all ${filter === 'all' ? 'bg-primary-500 text-white shadow-medium' : 'bg-neutral-100 text-neutral-600 hover:bg-neutral-200'}`}>
                                    Semua
                                </button>
                                <button onClick={() => setFilter('today')} className={`px-4 py-2 rounded-xl font-semibold transition-all ${filter === 'today' ? 'bg-primary-500 text-white shadow-medium' : 'bg-neutral-100 text-neutral-600 hover:bg-neutral-200'}`}>
                                    Hari Ini
                                </button>
                            </div>
                        </div>
                        
                        {loading ? (
                            <div className="text-center py-12">
                                <div className="w-16 h-16 bg-neutral-100 rounded-2xl flex items-center justify-center mx-auto mb-4 animate-pulse">
                                    <Icon name="spinner" className="text-3xl text-neutral-400 animate-spin" />
                                </div>
                                <p className="text-neutral-500">Memuat data...</p>
                            </div>
                        ) : salesHistory.length === 0 ? (
                            <div className="text-center py-12">
                                <div className="w-20 h-20 bg-neutral-100 rounded-2xl flex items-center justify-center mx-auto mb-4">
                                    <Icon name="receipt" className="text-4xl text-neutral-400" />
                                </div>
                                <p className="text-neutral-500 font-medium">Belum ada transaksi</p>
                            </div>
                        ) : (
                            <div className="space-y-3">
                                {salesHistory
                                    .filter(sale => {
                                        if (filter === 'today') {
                                            const date = sale.timestamp?.toDate();
                                            const today = new Date();
                                            return date && date.toDateString() === today.toDateString();
                                        }
                                        return true;
                                    })
                                    .map((sale, index) => (
                                        <div key={sale.id} className="bg-neutral-50 rounded-2xl p-5 hover:bg-neutral-100 transition-all card-hover">
                                            <div className="flex items-start justify-between mb-4">
                                                <div className="flex items-start gap-4">
                                                    <div className="w-12 h-12 bg-primary-100 rounded-xl flex items-center justify-center flex-shrink-0">
                                                        <Icon name="receipt" className="text-primary-500 text-xl" />
                                                    </div>
                                                    <div>
                                                        <div className="flex items-center gap-2 mb-1">
                                                            <p className="font-bold text-neutral-800">Transaksi #{index + 1}</p>
                                                            <span className="badge bg-success-100 text-success-600">Selesai</span>
                                                        </div>
                                                        <p className="text-sm text-neutral-600 mb-2">Pelanggan: {sale.customer || 'Umum'}</p>
                                                        <p className="text-xs text-neutral-500 flex items-center gap-1">
                                                            <Icon name="clock" />
                                                            {formatDate(sale.timestamp)}
                                                        </p>
                                                    </div>
                                                </div>
                                                <p className="text-xl font-black text-primary-600">Rp {(sale.total || 0).toLocaleString('id-ID')}</p>
                                            </div>
                                            <div className="border-t border-neutral-200 pt-4 mt-4">
                                                <p className="text-sm font-semibold text-neutral-700 mb-2">Item:</p>
                                                <div className="space-y-1">
                                                    {sale.items?.map((item, i) => (
                                                        <div key={i} className="flex items-center justify-between text-sm">
                                                            <span className="text-neutral-600">{item.name} x{item.qty}</span>
                                                            <span className="font-semibold text-neutral-800">Rp {item.subtotal.toLocaleString('id-ID')}</span>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        const PurchaseView = ({ user, showToast }) => {
            const [purchases, setPurchases] = useState([]);
            const [loading, setLoading] = useState(true);
            const [showForm, setShowForm] = useState(false);
            const [formData, setFormData] = useState({
                itemName: '',
                qty: '',
                price: '',
                supplier: '',
                note: ''
            });
            
            useEffect(() => {
                if (!user) return;
                const q = query(
                    collection(db, 'purchases'),
                    where('uid', '==', user.uid),
                    orderBy('timestamp', 'desc'),
                    limit(50)
                );
                
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const data = [];
                    snapshot.forEach(doc => {
                        data.push({ id: doc.id, ...doc.data() });
                    });
                    setPurchases(data);
                    setLoading(false);
                });
                
                return () => unsubscribe();
            }, [user]);
            
            const handleSubmit = async () => {
                if (!formData.itemName || !formData.qty || !formData.price) {
                    showToast('Mohon lengkapi data pembelian', 'error');
                    return;
                }
                
                try {
                    await addDoc(collection(db, 'purchases'), {
                        ...formData,
                        qty: parseInt(formData.qty),
                        price: parseFloat(formData.price),
                        total: parseInt(formData.qty) * parseFloat(formData.price),
                        timestamp: serverTimestamp(),
                        uid: user.uid
                    });
                    
                    showToast('Pembelian berhasil dicatat', 'success');
                    setFormData({ itemName: '', qty: '', price: '', supplier: '', note: '' });
                    setShowForm(false);
                } catch (error) {
                    showToast('Gagal mencatat pembelian', 'error');
                }
            };
            
            const formatDate = (timestamp) => {
                if (!timestamp) return '-';
                const date = timestamp.toDate();
                return new Intl.DateTimeFormat('id-ID', { dateStyle: 'medium', timeStyle: 'short' }).format(date);
            };
            
            const totalPurchases = purchases.reduce((sum, p) => sum + (p.total || 0), 0);
            
            return (
                <div className="space-y-6">
                    <div className="mb-8 flex items-center justify-between">
                        <div>
                            <h1 className="text-3xl font-black text-neutral-800 mb-2">Pembelian Barang</h1>
                            <p className="text-neutral-600">Kelola dan catat pembelian dari supplier</p>
                        </div>
                        <button onClick={() => setShowForm(true)} className="btn-primary text-white font-bold px-6 py-3 rounded-xl flex items-center gap-2">
                            <Icon name="plus" />
                            Tambah Pembelian
                        </button>
                    </div>
                    
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div className="stat-card rounded-3xl p-6 shadow-medium border border-primary-100">
                            <div className="flex items-start justify-between mb-4">
                                <div className="w-14 h-14 bg-gradient-to-br from-primary-500 to-primary-600 rounded-2xl flex items-center justify-center shadow-medium">
                                    <Icon name="box" className="text-white text-2xl" />
                                </div>
                            </div>
                            <p className="text-sm font-semibold text-neutral-600 mb-1 uppercase tracking-wider">Total Pembelian</p>
                            <p className="text-3xl font-black text-neutral-800">{purchases.length}</p>
                        </div>
                        <div className="stat-card rounded-3xl p-6 shadow-medium border border-danger-100">
                            <div className="flex items-start justify-between mb-4">
                                <div className="w-14 h-14 bg-gradient-to-br from-danger-500 to-danger-600 rounded-2xl flex items-center justify-center shadow-medium">
                                    <Icon name="money-bill" className="text-white text-2xl" />
                                </div>
                            </div>
                            <p className="text-sm font-semibold text-neutral-600 mb-1 uppercase tracking-wider">Total Pengeluaran</p>
                            <p className="text-3xl font-black text-neutral-800">Rp {totalPurchases.toLocaleString('id-ID')}</p>
                        </div>
                    </div>
                    
                    <div className="bg-white rounded-3xl p-6 shadow-medium">
                        <h3 className="text-xl font-bold text-neutral-800 mb-6">Riwayat Pembelian</h3>
                        {loading ? (
                            <div className="text-center py-12">
                                <div className="w-16 h-16 bg-neutral-100 rounded-2xl flex items-center justify-center mx-auto mb-4 animate-pulse">
                                    <Icon name="spinner" className="text-3xl text-neutral-400 animate-spin" />
                                </div>
                                <p className="text-neutral-500">Memuat data...</p>
                            </div>
                        ) : purchases.length === 0 ? (
                            <div className="text-center py-12">
                                <div className="w-20 h-20 bg-neutral-100 rounded-2xl flex items-center justify-center mx-auto mb-4">
                                    <Icon name="box" className="text-4xl text-neutral-400" />
                                </div>
                                <p className="text-neutral-500 font-medium">Belum ada data pembelian</p>
                            </div>
                        ) : (
                            <div className="space-y-3">
                                {purchases.map((purchase, index) => (
                                    <div key={purchase.id} className="bg-neutral-50 rounded-2xl p-5 hover:bg-neutral-100 transition-all card-hover">
                                        <div className="flex items-start justify-between">
                                            <div className="flex items-start gap-4">
                                                <div className="w-12 h-12 bg-primary-100 rounded-xl flex items-center justify-center flex-shrink-0">
                                                    <Icon name="box" className="text-primary-500 text-xl" />
                                                </div>
                                                <div>
                                                    <div className="flex items-center gap-2 mb-1">
                                                        <p className="font-bold text-neutral-800">{purchase.itemName}</p>
                                                        <span className="badge bg-primary-100 text-primary-600">{purchase.qty} unit</span>
                                                    </div>
                                                    <p className="text-sm text-neutral-600 mb-1">Supplier: {purchase.supplier || '-'}</p>
                                                    {purchase.note && <p className="text-sm text-neutral-600 mb-2">Catatan: {purchase.note}</p>}
                                                    <p className="text-xs text-neutral-500 flex items-center gap-1">
                                                        <Icon name="clock" />
                                                        {formatDate(purchase.timestamp)}
                                                    </p>
                                                </div>
                                            </div>
                                            <div className="text-right">
                                                <p className="text-xs text-neutral-500 mb-1">@ Rp {purchase.price.toLocaleString('id-ID')}</p>
                                                <p className="text-xl font-black text-danger-600">Rp {purchase.total.toLocaleString('id-ID')}</p>
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                    
                    {showForm && (
                        <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-neutral-900/40 backdrop-blur-sm fade-in" onClick={() => setShowForm(false)}>
                            <div className="bg-white rounded-3xl shadow-large max-w-md w-full p-8 scale-in" onClick={e => e.stopPropagation()}>
                                <h3 className="text-2xl font-bold text-neutral-800 mb-6">Tambah Pembelian</h3>
                                <div className="space-y-4 mb-6">
                                    <div>
                                        <label className="block text-sm font-semibold text-neutral-700 mb-2">Nama Barang *</label>
                                        <input type="text" placeholder="Contoh: Paracetamol 500mg" value={formData.itemName} onChange={e => setFormData({...formData, itemName: e.target.value})} className="w-full px-4 py-3 bg-neutral-50 border-2 border-neutral-200 rounded-xl font-medium text-neutral-800 transition-all" />
                                    </div>
                                    <div className="grid grid-cols-2 gap-4">
                                        <div>
                                            <label className="block text-sm font-semibold text-neutral-700 mb-2">Jumlah *</label>
                                            <input type="number" placeholder="0" value={formData.qty} onChange={e => setFormData({...formData, qty: e.target.value})} className="w-full px-4 py-3 bg-neutral-50 border-2 border-neutral-200 rounded-xl font-medium text-neutral-800 transition-all" />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-semibold text-neutral-700 mb-2">Harga Satuan *</label>
                                            <input type="number" placeholder="0" value={formData.price} onChange={e => setFormData({...formData, price: e.target.value})} className="w-full px-4 py-3 bg-neutral-50 border-2 border-neutral-200 rounded-xl font-medium text-neutral-800 transition-all" />
                                        </div>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-semibold text-neutral-700 mb-2">Supplier</label>
                                        <input type="text" placeholder="Nama supplier" value={formData.supplier} onChange={e => setFormData({...formData, supplier: e.target.value})} className="w-full px-4 py-3 bg-neutral-50 border-2 border-neutral-200 rounded-xl font-medium text-neutral-800 transition-all" />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-semibold text-neutral-700 mb-2">Catatan</label>
                                        <textarea placeholder="Tambahkan catatan..." value={formData.note} onChange={e => setFormData({...formData, note: e.target.value})} rows="3" className="w-full px-4 py-3 bg-neutral-50 border-2 border-neutral-200 rounded-xl font-medium text-neutral-800 transition-all resize-none"></textarea>
                                    </div>
                                    {formData.qty && formData.price && (
                                        <div className="bg-primary-50 rounded-2xl p-4 border-2 border-primary-200 text-center">
                                            <p className="text-sm font-semibold text-primary-600 mb-1">Total Pembelian</p>
                                            <p className="text-3xl font-black text-primary-700">Rp {(parseInt(formData.qty) * parseFloat(formData.price)).toLocaleString('id-ID')}</p>
                                        </div>
                                    )}
                                </div>
                                <div className="flex gap-3">
                                    <button onClick={() => setShowForm(false)} className="flex-1 bg-neutral-100 hover:bg-neutral-200 text-neutral-700 font-semibold py-4 rounded-xl transition-all">
                                        Batal
                                    </button>
                                    <button onClick={handleSubmit} className="flex-1 btn-primary text-white font-bold py-4 rounded-xl">
                                        <Icon name="check" className="mr-2" />
                                        Simpan
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const CashBookView = ({ user, currentProfile, showToast }) => {
            const [entries, setEntries] = useState([]);
            const [loading, setLoading] = useState(true);
            const [showForm, setShowForm] = useState(false);
            const [formData, setFormData] = useState({
                type: 'income',
                amount: '',
                category: '',
                description: '',
                date: new Date().toISOString().split('T')[0]
            });
            
            useEffect(() => {
                if (!user) return;
                const q = query(
                    collection(db, 'cashbook'),
                    where('uid', '==', user.uid),
                    where('storeId', '==', currentProfile.id),
                    orderBy('timestamp', 'desc'),
                    limit(100)
                );
                
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const data = [];
                    snapshot.forEach(doc => {
                        data.push({ id: doc.id, ...doc.data() });
                    });
                    setEntries(data);
                    setLoading(false);
                });
                
                return () => unsubscribe();
            }, [user, currentProfile]);
            
            const handleSubmit = async () => {
                if (!formData.amount || !formData.category) {
                    showToast('Mohon lengkapi data', 'error');
                    return;
                }
                
                try {
                    await addDoc(collection(db, 'cashbook'), {
                        ...formData,
                        amount: parseFloat(formData.amount),
                        timestamp: serverTimestamp(),
                        uid: user.uid,
                        storeId: currentProfile.id
                    });
                    
                    showToast('Data berhasil disimpan', 'success');
                    setFormData({ type: 'income', amount: '', category: '', description: '', date: new Date().toISOString().split('T')[0] });
                    setShowForm(false);
                } catch (error) {
                    showToast('Gagal menyimpan data', 'error');
                }
            };
            
            const formatDate = (timestamp) => {
                if (!timestamp) return '-';
                const date = timestamp.toDate();
                return new Intl.DateTimeFormat('id-ID', { dateStyle: 'medium' }).format(date);
            };
            
            const totalIncome = entries.filter(e => e.type === 'income').reduce((sum, e) => sum + (e.amount || 0), 0);
            const totalExpense = entries.filter(e => e.type === 'expense').reduce((sum, e) => sum + (e.amount || 0), 0);
            const balance = totalIncome - totalExpense;
            
            return (
                <div className="space-y-6">
                    <div className="mb-8 flex items-center justify-between">
                        <div>
                            <h1 className="text-3xl font-black text-neutral-800 mb-2">Buku Kas</h1>
                            <p className="text-neutral-600">Kelola pemasukan dan pengeluaran toko</p>
                        </div>
                        <button onClick={() => setShowForm(true)} className="btn-primary text-white font-bold px-6 py-3 rounded-xl flex items-center gap-2">
                            <Icon name="plus" />
                            Tambah Transaksi
                        </button>
                    </div>
                    
                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div className="stat-card rounded-3xl p-6 shadow-medium border border-success-100">
                            <div className="flex items-start justify-between mb-4">
                                <div className="w-14 h-14 bg-gradient-to-br from-success-500 to-success-600 rounded-2xl flex items-center justify-center shadow-medium">
                                    <Icon name="arrow-down" className="text-white text-2xl" />
                                </div>
                            </div>
                            <p className="text-sm font-semibold text-neutral-600 mb-1 uppercase tracking-wider">Total Pemasukan</p>
                            <p className="text-3xl font-black text-neutral-800">Rp {totalIncome.toLocaleString('id-ID')}</p>
                        </div>
                        <div className="stat-card rounded-3xl p-6 shadow-medium border border-danger-100">
                            <div className="flex items-start justify-between mb-4">
                                <div className="w-14 h-14 bg-gradient-to-br from-danger-500 to-danger-600 rounded-2xl flex items-center justify-center shadow-medium">
                                    <Icon name="arrow-up" className="text-white text-2xl" />
                                </div>
                            </div>
                            <p className="text-sm font-semibold text-neutral-600 mb-1 uppercase tracking-wider">Total Pengeluaran</p>
                            <p className="text-3xl font-black text-neutral-800">Rp {totalExpense.toLocaleString('id-ID')}</p>
                        </div>
                        <div className={`stat-card rounded-3xl p-6 shadow-medium border ${balance >= 0 ? 'border-primary-100' : 'border-warning-100'}`}>
                            <div className="flex items-start justify-between mb-4">
                                <div className={`w-14 h-14 bg-gradient-to-br ${balance >= 0 ? 'from-primary-500 to-primary-600' : 'from-warning-500 to-warning-600'} rounded-2xl flex items-center justify-center shadow-medium`}>
                                    <Icon name="wallet" className="text-white text-2xl" />
                                </div>
                            </div>
                            <p className="text-sm font-semibold text-neutral-600 mb-1 uppercase tracking-wider">Saldo</p>
                            <p className={`text-3xl font-black ${balance >= 0 ? 'text-neutral-800' : 'text-warning-600'}`}>Rp {balance.toLocaleString('id-ID')}</p>
                        </div>
                    </div>
                    
                    <div className="bg-white rounded-3xl p-6 shadow-medium">
                        <h3 className="text-xl font-bold text-neutral-800 mb-6">Riwayat Transaksi</h3>
                        {loading ? (
                            <div className="text-center py-12">
                                <div className="w-16 h-16 bg-neutral-100 rounded-2xl flex items-center justify-center mx-auto mb-4 animate-pulse">
                                    <Icon name="spinner" className="text-3xl text-neutral-400 animate-spin" />
                                </div>
                                <p className="text-neutral-500">Memuat data...</p>
                            </div>
                        ) : entries.length === 0 ? (
                            <div className="text-center py-12">
                                <div className="w-20 h-20 bg-neutral-100 rounded-2xl flex items-center justify-center mx-auto mb-4">
                                    <Icon name="book" className="text-4xl text-neutral-400" />
                                </div>
                                <p className="text-neutral-500 font-medium">Belum ada transaksi</p>
                            </div>
                        ) : (
                            <div className="space-y-3">
                                {entries.map(entry => (
                                    <div key={entry.id} className="bg-neutral-50 rounded-2xl p-5 hover:bg-neutral-100 transition-all card-hover">
                                        <div className="flex items-start justify-between">
                                            <div className="flex items-start gap-4">
                                                <div className={`w-12 h-12 ${entry.type === 'income' ? 'bg-success-100' : 'bg-danger-100'} rounded-xl flex items-center justify-center flex-shrink-0`}>
                                                    <Icon name={entry.type === 'income' ? 'arrow-down' : 'arrow-up'} className={`${entry.type === 'income' ? 'text-success-500' : 'text-danger-500'} text-xl`} />
                                                </div>
                                                <div>
                                                    <div className="flex items-center gap-2 mb-1">
                                                        <p className="font-bold text-neutral-800">{entry.category}</p>
                                                        <span className={`badge ${entry.type === 'income' ? 'bg-success-100 text-success-600' : 'bg-danger-100 text-danger-600'}`}>
                                                            {entry.type === 'income' ? 'Pemasukan' : 'Pengeluaran'}
                                                        </span>
                                                    </div>
                                                    {entry.description && <p className="text-sm text-neutral-600 mb-2">{entry.description}</p>}
                                                    <p className="text-xs text-neutral-500 flex items-center gap-1">
                                                        <Icon name="calendar" />
                                                        {formatDate(entry.timestamp)}
                                                    </p>
                                                </div>
                                            </div>
                                            <p className={`text-xl font-black ${entry.type === 'income' ? 'text-success-600' : 'text-danger-600'}`}>
                                                {entry.type === 'income' ? '+' : '-'} Rp {entry.amount.toLocaleString('id-ID')}
                                            </p>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                    
                    {showForm && (
                        <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-neutral-900/40 backdrop-blur-sm fade-in" onClick={() => setShowForm(false)}>
                            <div className="bg-white rounded-3xl shadow-large max-w-md w-full p-8 scale-in" onClick={e => e.stopPropagation()}>
                                <h3 className="text-2xl font-bold text-neutral-800 mb-6">Tambah Transaksi</h3>
                                <div className="space-y-4 mb-6">
                                    <div>
                                        <label className="block text-sm font-semibold text-neutral-700 mb-2">Tipe Transaksi *</label>
                                        <div className="grid grid-cols-2 gap-3">
                                            <button onClick={() => setFormData({...formData, type: 'income'})} className={`p-4 rounded-xl font-semibold transition-all ${formData.type === 'income' ? 'bg-success-500 text-white shadow-medium' : 'bg-neutral-100 text-neutral-600 hover:bg-neutral-200'}`}>
                                                <Icon name="arrow-down" className="mr-2" />
                                                Pemasukan
                                            </button>
                                            <button onClick={() => setFormData({...formData, type: 'expense'})} className={`p-4 rounded-xl font-semibold transition-all ${formData.type === 'expense' ? 'bg-danger-500 text-white shadow-medium' : 'bg-neutral-100 text-neutral-600 hover:bg-neutral-200'}`}>
                                                <Icon name="arrow-up" className="mr-2" />
                                                Pengeluaran
                                            </button>
                                        </div>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-semibold text-neutral-700 mb-2">Jumlah *</label>
                                        <div className="relative">
                                            <span className="absolute left-4 top-1/2 -translate-y-1/2 text-neutral-500 font-semibold">Rp</span>
                                            <input type="number" placeholder="0" value={formData.amount} onChange={e => setFormData({...formData, amount: e.target.value})} className="w-full pl-12 pr-4 py-4 bg-neutral-50 border-2 border-neutral-200 rounded-xl font-bold text-xl text-neutral-800 transition-all" />
                                        </div>
                                    </div>
                                    <div>
                                        <label className="block text-sm font-semibold text-neutral-700 mb-2">Kategori *</label>
                                        <input type="text" placeholder="Contoh: Gaji, Listrik, dll" value={formData.category} onChange={e => setFormData({...formData, category: e.target.value})} className="w-full px-4 py-3 bg-neutral-50 border-2 border-neutral-200 rounded-xl font-medium text-neutral-800 transition-all" />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-semibold text-neutral-700 mb-2">Tanggal *</label>
                                        <input type="date" value={formData.date} onChange={e => setFormData({...formData, date: e.target.value})} className="w-full px-4 py-3 bg-neutral-50 border-2 border-neutral-200 rounded-xl font-medium text-neutral-800 transition-all" />
                                    </div>
                                    <div>
                                        <label className="block text-sm font-semibold text-neutral-700 mb-2">Keterangan</label>
                                        <textarea placeholder="Tambahkan keterangan..." value={formData.description} onChange={e => setFormData({...formData, description: e.target.value})} rows="3" className="w-full px-4 py-3 bg-neutral-50 border-2 border-neutral-200 rounded-xl font-medium text-neutral-800 transition-all resize-none"></textarea>
                                    </div>
                                </div>
                                <div className="flex gap-3">
                                    <button onClick={() => setShowForm(false)} className="flex-1 bg-neutral-100 hover:bg-neutral-200 text-neutral-700 font-semibold py-4 rounded-xl transition-all">
                                        Batal
                                    </button>
                                    <button onClick={handleSubmit} className="flex-1 btn-primary text-white font-bold py-4 rounded-xl">
                                        <Icon name="check" className="mr-2" />
                                        Simpan
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const ListView = ({ items, loading, settings, searchQuery, setSearchQuery, showOnlyLowStock, setShowOnlyLowStock, selectedRacks, setSelectedRacks, uniqueRacksData, onCopySuccess, onEdit, onDelete, onDeleteRack, currentProfile }) => {
            const [sortBy, setSortBy] = useState('name');
            const [sortDirection, setSortDirection] = useState('asc');
            
            const filteredItems = items.filter(item => {
                const matchesSearch = item.name.toLowerCase().includes(searchQuery.toLowerCase());
                const matchesRacks = selectedRacks.length === 0 || selectedRacks.includes(item.rack || '-');
                const matchesLowStock = !showOnlyLowStock || (
                    parseInt(item.qty) <= (parseInt(item.minStock) || parseInt(settings.minStockDefault) || 0) &&
                    (parseInt(item.minStock) || parseInt(settings.minStockDefault) || 0) > 0
                );
                return matchesSearch && matchesRacks && matchesLowStock;
            });
            
            const sortedItems = [...filteredItems].sort((a, b) => {
                let comparison = 0;
                if (sortBy === 'name') comparison = a.name.localeCompare(b.name);
                else if (sortBy === 'qty') comparison = parseInt(a.qty) - parseInt(b.qty);
                else if (sortBy === 'price') comparison = parseFloat(a.price) - parseFloat(b.price);
                return sortDirection === 'asc' ? comparison : -comparison;
            });
            
            const handleSort = (field) => {
                if (sortBy === field) {
                    setSortDirection(sortDirection === 'asc' ? 'desc' : 'asc');
                } else {
                    setSortBy(field);
                    setSortDirection('asc');
                }
            };
            
            return (
                <div className="space-y-6">
                    <div className="mb-8">
                        <h1 className="text-3xl font-black text-neutral-800 mb-2">Daftar Barang</h1>
                        <p className="text-neutral-600">Kelola semua barang dalam inventory</p>
                    </div>
                    
                    <div className="bg-white rounded-3xl p-6 shadow-medium">
                        <div className="flex flex-col lg:flex-row gap-4 mb-6">
                            <div className="flex-1 relative">
                                <Icon name="search" className="absolute left-4 top-1/2 -translate-y-1/2 text-neutral-400" />
                                <input
                                    type="text"
                                    placeholder="Cari barang..."
                                    value={searchQuery}
                                    onChange={(e) => setSearchQuery(e.target.value)}
                                    className="w-full pl-12 pr-4 py-4 bg-neutral-50 border-2 border-neutral-200 rounded-2xl font-medium text-neutral-800 transition-all"
                                />
                            </div>
                            <div className="flex gap-3">
                                <button onClick={() => setShowOnlyLowStock(!showOnlyLowStock)} className={`px-6 py-4 rounded-2xl font-semibold transition-all flex items-center gap-2 ${showOnlyLowStock ? 'bg-warning-500 text-white shadow-medium' : 'bg-neutral-100 text-neutral-600 hover:bg-neutral-200'}`}>
                                    <Icon name="exclamation-triangle" />
                                    Stok Menipis
                                </button>
                                <select value={sortBy} onChange={(e) => setSortBy(e.target.value)} className="px-6 py-4 bg-neutral-100 border-2 border-neutral-200 rounded-2xl font-semibold text-neutral-700 transition-all">
                                    <option value="name">Urutkan: Nama</option>
                                    <option value="qty">Urutkan: Stok</option>
                                    <option value="price">Urutkan: Harga</option>
                                </select>
                            </div>
                        </div>
                        
                        {uniqueRacksData.length > 0 && (
                            <div className="flex flex-wrap gap-2 mb-6">
                                <button onClick={() => setSelectedRacks([])} className={`px-4 py-2 rounded-xl font-semibold text-sm transition-all ${selectedRacks.length === 0 ? 'bg-primary-500 text-white shadow-medium' : 'bg-neutral-100 text-neutral-600 hover:bg-neutral-200'}`}>
                                    Semua Rak
                                </button>
                                {uniqueRacksData.map(rack => (
                                    <button key={rack.name} onClick={() => {
                                        if (selectedRacks.includes(rack.name)) {
                                            setSelectedRacks(selectedRacks.filter(r => r !== rack.name));
                                        } else {
                                            setSelectedRacks([...selectedRacks, rack.name]);
                                        }
                                    }} className={`px-4 py-2 rounded-xl font-semibold text-sm transition-all ${selectedRacks.includes(rack.name) ? 'bg-primary-500 text-white shadow-medium' : 'bg-neutral-100 text-neutral-600 hover:bg-neutral-200'}`}>
                                        {rack.name} ({rack.count})
                                    </button>
                                ))}
                            </div>
                        )}
                        
                        {loading ? (
                            <div className="text-center py-12">
                                <div className="w-16 h-16 bg-neutral-100 rounded-2xl flex items-center justify-center mx-auto mb-4 animate-pulse">
                                    <Icon name="spinner" className="text-3xl text-neutral-400 animate-spin" />
                                </div>
                                <p className="text-neutral-500">Memuat data...</p>
                            </div>
                        ) : sortedItems.length === 0 ? (
                            <div className="text-center py-12">
                                <div className="w-20 h-20 bg-neutral-100 rounded-2xl flex items-center justify-center mx-auto mb-4">
                                    <Icon name="inbox" className="text-4xl text-neutral-400" />
                                </div>
                                <p className="text-neutral-500 font-medium">Tidak ada barang ditemukan</p>
                            </div>
                        ) : (
                            <div className="overflow-x-auto">
                                <table className="w-full">
                                    <thead>
                                        <tr className="table-header text-left">
                                            <th className="px-4 py-4 font-bold text-neutral-700 text-sm uppercase tracking-wider rounded-tl-xl">Nama Barang</th>
                                            <th className="px-4 py-4 font-bold text-neutral-700 text-sm uppercase tracking-wider text-center">Stok</th>
                                            <th className="px-4 py-4 font-bold text-neutral-700 text-sm uppercase tracking-wider text-center">Rak</th>
                                            <th className="px-4 py-4 font-bold text-neutral-700 text-sm uppercase tracking-wider text-right">Harga</th>
                                            <th className="px-4 py-4 font-bold text-neutral-700 text-sm uppercase tracking-wider text-center rounded-tr-xl">Aksi</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {sortedItems.map((item, index) => {
                                            const minStock = parseInt(item.minStock) || parseInt(settings.minStockDefault) || 0;
                                            const isLowStock = parseInt(item.qty) <= minStock && minStock > 0;
                                            const isOutOfStock = parseInt(item.qty) === 0;
                                            
                                            return (
                                                <tr key={item.id} className="table-row border-b border-neutral-100">
                                                    <td className="px-4 py-5">
                                                        <div className="flex items-center gap-3">
                                                            <div className="w-10 h-10 bg-primary-100 rounded-xl flex items-center justify-center flex-shrink-0">
                                                                <Icon name="box" className="text-primary-500" />
                                                            </div>
                                                            <div>
                                                                <p className="font-bold text-neutral-800">{item.name}</p>
                                                                {item.exp && <p className="text-xs text-neutral-500">EXP: {item.exp}</p>}
                                                            </div>
                                                        </div>
                                                    </td>
                                                    <td className="px-4 py-5 text-center">
                                                        <span className={`badge ${isOutOfStock ? 'bg-danger-100 text-danger-600' : isLowStock ? 'bg-warning-100 text-warning-600' : 'bg-success-100 text-success-600'}`}>
                                                            {item.qty} {item.unit}
                                                        </span>
                                                    </td>
                                                    <td className="px-4 py-5 text-center">
                                                        <span className="badge bg-neutral-100 text-neutral-600">
                                                            <Icon name="location-dot" className="text-xs" />
                                                            {item.rack || '-'}
                                                        </span>
                                                    </td>
                                                    <td className="px-4 py-5 text-right">
                                                        <p className="font-bold text-primary-600">Rp {parseFloat(item.price).toLocaleString('id-ID')}</p>
                                                    </td>
                                                    <td className="px-4 py-5">
                                                        <div className="flex items-center justify-center gap-2">
                                                            <button onClick={() => onEdit(item)} className="w-9 h-9 bg-primary-100 hover:bg-primary-500 text-primary-500 hover:text-white rounded-lg transition-all flex items-center justify-center">
                                                                <Icon name="edit" />
                                                            </button>
                                                            <button onClick={() => onDelete(item)} className="w-9 h-9 bg-danger-100 hover:bg-danger-500 text-danger-500 hover:text-white rounded-lg transition-all flex items-center justify-center">
                                                                <Icon name="trash" />
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                            );
                                        })}
                                    </tbody>
                                </table>
                            </div>
                        )}
                        
                        <div className="mt-6 pt-6 border-t border-neutral-200">
                            <p className="text-sm text-neutral-600 text-center">
                                Menampilkan <span className="font-bold text-neutral-800">{sortedItems.length}</span> dari <span className="font-bold text-neutral-800">{items.length}</span> barang
                            </p>
                        </div>
                    </div>
                </div>
            );
        };

        const FormView = ({ formData, setFormData, onSubmit, isEditing, submitting, onCancel, currentProfile }) => {
            return (
                <div className="space-y-6">
                    <div className="mb-8">
                        <h1 className="text-3xl font-black text-neutral-800 mb-2">{isEditing ? 'Edit Barang' : 'Tambah Barang'}</h1>
                        <p className="text-neutral-600">{isEditing ? 'Perbarui informasi barang' : 'Tambahkan barang baru ke inventory'}</p>
                    </div>
                    
                    <div className="bg-white rounded-3xl p-8 shadow-medium max-w-3xl mx-auto">
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                            <div className="md:col-span-2">
                                <label className="block text-sm font-bold text-neutral-700 mb-3">Nama Barang *</label>
                                <input
                                    type="text"
                                    placeholder="Contoh: Paracetamol 500mg"
                                    value={formData.name}
                                    onChange={(e) => setFormData({...formData, name: e.target.value})}
                                    className="w-full px-5 py-4 bg-neutral-50 border-2 border-neutral-200 rounded-2xl font-medium text-neutral-800 transition-all placeholder:text-neutral-400"
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-bold text-neutral-700 mb-3">Jumlah Stok *</label>
                                <input
                                    type="number"
                                    placeholder="0"
                                    value={formData.qty}
                                    onChange={(e) => setFormData({...formData, qty: e.target.value})}
                                    className="w-full px-5 py-4 bg-neutral-50 border-2 border-neutral-200 rounded-2xl font-medium text-neutral-800 transition-all placeholder:text-neutral-400"
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-bold text-neutral-700 mb-3">Satuan *</label>
                                <select
                                    value={formData.unit}
                                    onChange={(e) => setFormData({...formData, unit: e.target.value})}
                                    className="w-full px-5 py-4 bg-neutral-50 border-2 border-neutral-200 rounded-2xl font-medium text-neutral-800 transition-all"
                                >
                                    <option value="Pcs">Pcs</option>
                                    <option value="Box">Box</option>
                                    <option value="Pack">Pack</option>
                                    <option value="Dus">Dus</option>
                                    <option value="Botol">Botol</option>
                                    <option value="Strip">Strip</option>
                                    <option value="Tablet">Tablet</option>
                                    <option value="Kapsul">Kapsul</option>
                                    <option value="Tube">Tube</option>
                                    <option value="Sachet">Sachet</option>
                                </select>
                            </div>
                            <div>
                                <label className="block text-sm font-bold text-neutral-700 mb-3">Harga Jual *</label>
                                <div className="relative">
                                    <span className="absolute left-5 top-1/2 -translate-y-1/2 text-neutral-500 font-semibold">Rp</span>
                                    <input
                                        type="number"
                                        placeholder="0"
                                        value={formData.price}
                                        onChange={(e) => setFormData({...formData, price: e.target.value})}
                                        className="w-full pl-14 pr-5 py-4 bg-neutral-50 border-2 border-neutral-200 rounded-2xl font-medium text-neutral-800 transition-all placeholder:text-neutral-400"
                                    />
                                </div>
                            </div>
                            <div>
                                <label className="block text-sm font-bold text-neutral-700 mb-3">Minimum Stok</label>
                                <input
                                    type="number"
                                    placeholder="0"
                                    value={formData.minStock}
                                    onChange={(e) => setFormData({...formData, minStock: e.target.value})}
                                    className="w-full px-5 py-4 bg-neutral-50 border-2 border-neutral-200 rounded-2xl font-medium text-neutral-800 transition-all placeholder:text-neutral-400"
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-bold text-neutral-700 mb-3">Tanggal Kadaluarsa</label>
                                <input
                                    type="date"
                                    value={formData.exp}
                                    onChange={(e) => setFormData({...formData, exp: e.target.value})}
                                    className="w-full px-5 py-4 bg-neutral-50 border-2 border-neutral-200 rounded-2xl font-medium text-neutral-800 transition-all"
                                />
                            </div>
                            <div>
                                <label className="block text-sm font-bold text-neutral-700 mb-3">Lokasi Rak</label>
                                <input
                                    type="text"
                                    placeholder="Contoh: A1, B2, dll"
                                    value={formData.rack}
                                    onChange={(e) => setFormData({...formData, rack: e.target.value})}
                                    className="w-full px-5 py-4 bg-neutral-50 border-2 border-neutral-200 rounded-2xl font-medium text-neutral-800 transition-all placeholder:text-neutral-400"
                                />
                            </div>
                        </div>
                        
                        <div className="flex gap-4 pt-6 border-t border-neutral-200">
                            <button
                                onClick={onCancel}
                                className="flex-1 bg-neutral-100 hover:bg-neutral-200 text-neutral-700 font-bold py-4 rounded-2xl transition-all flex items-center justify-center gap-2"
                            >
                                <Icon name="xmark" />
                                Batal
                            </button>
                            <button
                                onClick={onSubmit}
                                disabled={submitting}
                                className="flex-1 btn-primary text-white font-bold py-4 rounded-2xl disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                            >
                                {submitting ? (
                                    <>
                                        <Icon name="spinner" className="animate-spin" />
                                        Menyimpan...
                                    </>
                                ) : (
                                    <>
                                        <Icon name="check" />
                                        {isEditing ? 'Update Barang' : 'Simpan Barang'}
                                    </>
                                )}
                            </button>
                        </div>
                    </div>
                </div>
            );
        };

        const BulkImportView = ({ user, onImportComplete, currentProfile, settings }) => {
            const [importData, setImportData] = useState('');
            const [importing, setImporting] = useState(false);
            
            const handleImport = async () => {
                if (!importData.trim()) return;
                
                setImporting(true);
                try {
                    const lines = importData.trim().split('\n');
                    const batch = writeBatch(db);
                    let count = 0;
                    
                    for (let line of lines) {
                        const parts = line.split(',').map(p => p.trim());
                        if (parts.length >= 4) {
                            const [name, qty, unit, price] = parts;
                            const docRef = doc(collection(db, 'items'));
                            batch.set(docRef, {
                                name,
                                qty: qty || '0',
                                unit: unit || 'Pcs',
                                price: price || '0',
                                exp: '',
                                rack: '',
                                minStock: '',
                                timestamp: serverTimestamp(),
                                uid: user.uid,
                                storeId: currentProfile.id
                            });
                            count++;
                        }
                    }
                    
                    await batch.commit();
                    onImportComplete(count);
                } catch (error) {
                    console.error('Import error:', error);
                } finally {
                    setImporting(false);
                }
            };
            
            return (
                <div className="space-y-6">
                    <div className="mb-8">
                        <h1 className="text-3xl font-black text-neutral-800 mb-2">Import Barang</h1>
                        <p className="text-neutral-600">Import data barang secara massal menggunakan format CSV</p>
                    </div>
                    
                    <div className="bg-white rounded-3xl p-8 shadow-medium max-w-3xl mx-auto">
                        <div className="mb-6">
                            <div className="bg-primary-50 border-2 border-primary-200 rounded-2xl p-6 mb-4">
                                <h3 className="text-lg font-bold text-neutral-800 mb-3 flex items-center gap-2">
                                    <Icon name="info-circle" className="text-primary-500" />
                                    Format Import
                                </h3>
                                <p className="text-sm text-neutral-600 mb-3">
                                    Masukkan data dengan format: <span className="font-mono bg-white px-2 py-1 rounded">Nama, Qty, Unit, Harga</span>
                                </p>
                                <div className="bg-white rounded-xl p-4 font-mono text-sm text-neutral-700 border border-neutral-200">
                                    Paracetamol 500mg, 100, Box, 50000<br />
                                    Amoxicillin 500mg, 50, Strip, 75000<br />
                                    Vitamin C 1000mg, 200, Botol, 25000
                                </div>
                            </div>
                            
                            <label className="block text-sm font-bold text-neutral-700 mb-3">Data Import</label>
                            <textarea
                                placeholder="Masukkan data barang di sini..."
                                value={importData}
                                onChange={(e) => setImportData(e.target.value)}
                                rows="12"
                                className="w-full px-5 py-4 bg-neutral-50 border-2 border-neutral-200 rounded-2xl font-mono text-sm text-neutral-800 transition-all resize-none"
                            ></textarea>
                        </div>
                        
                        <button
                            onClick={handleImport}
                            disabled={importing || !importData.trim()}
                            className="w-full btn-primary text-white font-bold py-4 rounded-2xl disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                        >
                            {importing ? (
                                <>
                                    <Icon name="spinner" className="animate-spin" />
                                    Mengimport...
                                </>
                            ) : (
                                <>
                                    <Icon name="file-import" />
                                    Import Data
                                </>
                            )}
                        </button>
                    </div>
                </div>
            );
        };

        const SettingsView = ({ settings, onSave, loading }) => {
            const [localSettings, setLocalSettings] = useState(settings);
            const [showAddStore, setShowAddStore] = useState(false);
            const [newStoreName, setNewStoreName] = useState('');
            
            const handleAddStore = () => {
                if (!newStoreName.trim()) return;
                const newStore = {
                    id: `store_${Date.now()}`,
                    name: newStoreName.trim()
                };
                setLocalSettings({
                    ...localSettings,
                    storeProfiles: [...(localSettings.storeProfiles || []), newStore]
                });
                setNewStoreName('');
                setShowAddStore(false);
            };
            
            const handleDeleteStore = (storeId) => {
                setLocalSettings({
                    ...localSettings,
                    storeProfiles: localSettings.storeProfiles.filter(s => s.id !== storeId)
                });
            };
            
            return (
                <div className="space-y-6">
                    <div className="mb-8">
                        <h1 className="text-3xl font-black text-neutral-800 mb-2">Pengaturan</h1>
                        <p className="text-neutral-600">Kelola preferensi dan konfigurasi aplikasi</p>
                    </div>
                    
                    <div className="bg-white rounded-3xl p-8 shadow-medium max-w-3xl mx-auto">
                        <div className="space-y-8">
                            <div>
                                <h3 className="text-xl font-bold text-neutral-800 mb-4 flex items-center gap-2">
                                    <Icon name="store" className="text-primary-500" />
                                    Kelola Toko
                                </h3>
                                <div className="space-y-3">
                                    {(localSettings.storeProfiles || []).map(store => (
                                        <div key={store.id} className="bg-neutral-50 rounded-2xl p-4 flex items-center justify-between">
                                            <div className="flex items-center gap-3">
                                                <div className="w-10 h-10 bg-primary-100 rounded-xl flex items-center justify-center">
                                                    <Icon name="store" className="text-primary-500" />
                                                </div>
                                                <p className="font-bold text-neutral-800">{store.name}</p>
                                            </div>
                                            <button
                                                onClick={() => handleDeleteStore(store.id)}
                                                className="w-9 h-9 bg-danger-100 hover:bg-danger-500 text-danger-500 hover:text-white rounded-lg transition-all flex items-center justify-center"
                                            >
                                                <Icon name="trash" />
                                            </button>
                                        </div>
                                    ))}
                                    <button
                                        onClick={() => setShowAddStore(true)}
                                        className="w-full bg-neutral-100 hover:bg-primary-50 border-2 border-dashed border-neutral-300 hover:border-primary-300 text-neutral-600 hover:text-primary-600 font-semibold py-4 rounded-2xl transition-all flex items-center justify-center gap-2"
                                    >
                                        <Icon name="plus" />
                                        Tambah Toko Baru
                                    </button>
                                </div>
                            </div>
                            
                            <div>
                                <h3 className="text-xl font-bold text-neutral-800 mb-4 flex items-center gap-2">
                                    <Icon name="sliders" className="text-primary-500" />
                                    Pengaturan Umum
                                </h3>
                                <div className="space-y-4">
                                    <div>
                                        <label className="block text-sm font-bold text-neutral-700 mb-3">Minimum Stok Default</label>
                                        <input
                                            type="number"
                                            placeholder="0"
                                            value={localSettings.minStockDefault || ''}
                                            onChange={(e) => setLocalSettings({...localSettings, minStockDefault: e.target.value})}
                                            className="w-full px-5 py-4 bg-neutral-50 border-2 border-neutral-200 rounded-2xl font-medium text-neutral-800 transition-all"
                                        />
                                        <p className="text-xs text-neutral-500 mt-2">Nilai default untuk peringatan stok menipis</p>
                                    </div>
                                </div>
                            </div>
                            
                            <button
                                onClick={() => onSave(localSettings)}
                                disabled={loading}
                                className="w-full btn-primary text-white font-bold py-4 rounded-2xl disabled:opacity-50 disabled:cursor-not-allowed flex items-center justify-center gap-2"
                            >
                                {loading ? (
                                    <>
                                        <Icon name="spinner" className="animate-spin" />
                                        Menyimpan...
                                    </>
                                ) : (
                                    <>
                                        <Icon name="save" />
                                        Simpan Pengaturan
                                    </>
                                )}
                            </button>
                        </div>
                    </div>
                    
                    {showAddStore && (
                        <div className="fixed inset-0 z-[100] flex items-center justify-center p-4 bg-neutral-900/40 backdrop-blur-sm fade-in" onClick={() => setShowAddStore(false)}>
                            <div className="bg-white rounded-3xl shadow-large max-w-md w-full p-8 scale-in" onClick={e => e.stopPropagation()}>
                                <h3 className="text-2xl font-bold text-neutral-800 mb-6">Tambah Toko Baru</h3>
                                <div className="mb-6">
                                    <label className="block text-sm font-bold text-neutral-700 mb-3">Nama Toko</label>
                                    <input
                                        type="text"
                                        placeholder="Contoh: Cabang Jakarta"
                                        value={newStoreName}
                                        onChange={(e) => setNewStoreName(e.target.value)}
                                        className="w-full px-5 py-4 bg-neutral-50 border-2 border-neutral-200 rounded-2xl font-medium text-neutral-800 transition-all"
                                    />
                                </div>
                                <div className="flex gap-3">
                                    <button
                                        onClick={() => setShowAddStore(false)}
                                        className="flex-1 bg-neutral-100 hover:bg-neutral-200 text-neutral-700 font-semibold py-4 rounded-xl transition-all"
                                    >
                                        Batal
                                    </button>
                                    <button
                                        onClick={handleAddStore}
                                        disabled={!newStoreName.trim()}
                                        className="flex-1 btn-primary text-white font-bold py-4 rounded-xl disabled:opacity-50"
                                    >
                                        <Icon name="check" className="mr-2" />
                                        Tambah
                                    </button>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const App = () => {
            const [user, setUser] = useState(null);
            const [loading, setLoading] = useState(true);
            const [activeTab, setActiveTab] = useState('home');
            const [inventoryData, setInventoryData] = useState([]);
            const [rawInventory, setRawInventory] = useState([]);
            const [settingsData, setSettingsData] = useState({});
            const [formData, setFormData] = useState({name:'', qty:'', unit:'Pcs', exp:'', rack:'', price:'', minStock: ''});
            const [editingItem, setEditingItem] = useState(null);
            const [submitting, setSubmitting] = useState(false);
            const [deleteModal, setDeleteModal] = useState({ show: false, item: null });
            const [deleteRackModal, setDeleteRackModal] = useState({ show: false, rackName: null });
            const [toast, setToast] = useState(null);
            const [isSidebarOpen, setIsSidebarOpen] = useState(false);
            const [activeStoreId, setActiveStoreId] = useState('default');
            const [showStoreMenu, setShowStoreMenu] = useState(false);
            const [searchQuery, setSearchQuery] = useState('');
            const [showOnlyLowStock, setShowOnlyLowStock] = useState(false);
            const [selectedRacks, setSelectedRacks] = useState([]);
            const [showNotifications, setShowNotifications] = useState(false);
            const [activities, setActivities] = useState([]);
            
            const showToast = (message, type = 'success') => {
                setToast({ message, type });
            };
            
            useEffect(() => {
                const unsubscribe = onAuthStateChanged(auth, async (currentUser) => {
                    if (currentUser) {
                        setUser(currentUser);
                        
                        const settingsDocRef = doc(db, 'settings', currentUser.uid);
                        const settingsDoc = await getDoc(settingsDocRef);
                        
                        if (!settingsDoc.exists()) {
                            await setDoc(settingsDocRef, {
                                storeProfiles: [{ id: 'default', name: APP_NAME }],
                                minStockDefault: '10'
                            });
                        }
                        
                        setLoading(false);
                    } else {
                        signInAnonymously(auth).catch(console.error);
                    }
                });
                return () => unsubscribe();
            }, []);
            
            useEffect(() => {
                if (!user) return;
                const q = query(collection(db, 'items'), where('uid', '==', user.uid), orderBy('timestamp', 'desc'));
                const unsubscribe = onSnapshot(q, (snapshot) => {
                    const items = [];
                    snapshot.forEach(doc => {
                        items.push({ id: doc.id, ...doc.data() });
                    });
                    setRawInventory(items);
                });
                return () => unsubscribe();
            }, [user]);
            
            useEffect(() => {
                if (!user) return;
                const docRef = doc(db, 'settings', user.uid);
                const unsubscribe = onSnapshot(docRef, (doc) => {
                    if (doc.exists()) {
                        setSettingsData(doc.data());
                    }
                });
                return () => unsubscribe();
            }, [user]);
            
            useEffect(() => {
                if (!user) return;
                const queries = [
                    query(collection(db, 'sales'), where('uid', '==', user.uid), orderBy('timestamp', 'desc'), limit(10)),
                    query(collection(db, 'purchases'), where('uid', '==', user.uid), orderBy('timestamp', 'desc'), limit(10)),
                    query(collection(db, 'cashbook'), where('uid', '==', user.uid), orderBy('timestamp', 'desc'), limit(10))
                ];
                
                Promise.all(queries.map(q => getDocs(q))).then(results => {
                    const allActivities = [];
                    results[0].forEach(doc => {
                        const data = doc.data();
                        allActivities.push({
                            type: 'sale',
                            title: `Penjualan #${doc.id.slice(-6)}`,
                            description: `${data.items?.length || 0} item terjual`,
                            amount: data.total,
                            time: data.timestamp ? new Intl.DateTimeFormat('id-ID', {dateStyle: 'short', timeStyle: 'short'}).format(data.timestamp.toDate()) : '-'
                        });
                    });
                    results[1].forEach(doc => {
                        const data = doc.data();
                        allActivities.push({
                            type: 'purchase',
                            title: 'Pembelian Barang',
                            description: data.itemName,
                            amount: data.total,
                            time: data.timestamp ? new Intl.DateTimeFormat('id-ID', {dateStyle: 'short', timeStyle: 'short'}).format(data.timestamp.toDate()) : '-'
                        });
                    });
                    results[2].forEach(doc => {
                        const data = doc.data();
                        allActivities.push({
                            type: data.type === 'expense' ? 'expense' : 'sale',
                            title: data.category,
                            description: data.description || '-',
                            amount: data.amount,
                            time: data.timestamp ? new Intl.DateTimeFormat('id-ID', {dateStyle: 'short', timeStyle: 'short'}).format(data.timestamp.toDate()) : '-'
                        });
                    });
                    setActivities(allActivities);
                });
            }, [user]);
            
            useEffect(() => {
                if (activeStoreId === 'all_stores') {
                    setInventoryData(rawInventory);
                } else {
                    setInventoryData(rawInventory.filter(item => item.storeId === activeStoreId));
                }
            }, [activeStoreId, rawInventory]);
            
            const currentProfile = (settingsData.storeProfiles || [{id:'default', name: APP_NAME}]).find(p => p.id === activeStoreId) || {id:'default', name: APP_NAME};
            
            const uniqueRacksData = [...new Set(inventoryData.filter(item => item.rack && item.rack !== '-').map(item => item.rack))]
                .map(rackName => ({ name: rackName, count: inventoryData.filter(item => item.rack === rackName).length }));
            
            const handleSubmit = async () => {
                if (!formData.name || !formData.qty || !formData.price) {
                    showToast('Mohon isi semua field yang wajib', 'error');
                    return;
                }
                
                setSubmitting(true);
                try {
                    if (editingItem) {
                        await updateDoc(doc(db, 'items', editingItem.id), formData);
                        showToast('Barang berhasil diupdate', 'success');
                    } else {
                        await addDoc(collection(db, 'items'), {
                            ...formData,
                            timestamp: serverTimestamp(),
                            uid: user.uid,
                            storeId: activeStoreId
                        });
                        showToast('Barang berhasil ditambahkan', 'success');
                    }
                    
                    setEditingItem(null);
                    setFormData({name:'', qty:'', unit:'Pcs', exp:'', rack:'', price:'', minStock: ''});
                    setActiveTab('list');
                } catch (error) {
                    showToast('Gagal menyimpan data', 'error');
                } finally {
                    setSubmitting(false);
                }
            };
            
            const handleDelete = async () => {
                try {
                    await deleteDoc(doc(db, 'items', deleteModal.item.id));
                    showToast('Barang berhasil dihapus', 'success');
                } catch (error) {
                    showToast('Gagal menghapus barang', 'error');
                }
            };
            
            const handleConfirmDeleteRack = async () => {
                try {
                    const batch = writeBatch(db);
                    const itemsInRack = inventoryData.filter(item => item.rack === deleteRackModal.rackName);
                    itemsInRack.forEach(item => {
                        const itemRef = doc(db, 'items', item.id);
                        batch.update(itemRef, { rack: '-' });
                    });
                    await batch.commit();
                    showToast('Rak berhasil dihapus', 'success');
                } catch (error) {
                    showToast('Gagal menghapus rak', 'error');
                }
            };
            
            const handleSaveSettings = async (newSettings) => {
                setSubmitting(true);
                try {
                    await setDoc(doc(db, 'settings', user.uid), newSettings);
                    showToast('Pengaturan berhasil disimpan', 'success');
                } catch (error) {
                    showToast('Gagal menyimpan pengaturan', 'error');
                } finally {
                    setSubmitting(false);
                }
            };
            
            const handleSwitchStore = (storeId) => {
                setActiveStoreId(storeId);
                setShowStoreMenu(false);
                setActiveTab('home');
            };
            
            const handleNavClick = (tabId, e) => {
                e.preventDefault();
                setActiveTab(tabId);
                setIsSidebarOpen(false);
                if (tabId === 'list') {
                    setShowOnlyLowStock(false);
                }
            };
            
            const handleGenerateImage = async (elementId) => {
                try {
                    const element = document.getElementById(elementId);
                    const canvas = await html2canvas(element, { scale: 2, backgroundColor: '#ffffff' });
                    const imgData = canvas.toDataURL('image/jpeg', 0.9);
                    const link = document.createElement('a');
                    link.href = imgData;
                    link.download = `${elementId}_${Date.now()}.jpg`;
                    link.click();
                    showToast('Gambar berhasil diunduh', 'success');
                } catch (error) {
                    showToast('Gagal mengunduh gambar', 'error');
                }
            };
            
            const menuItems = [
                { id: 'home', icon: 'home', label: 'Dashboard' },
                { id: 'cashier', icon: 'cash-register', label: 'Kasir' },
                { id: 'list', icon: 'list', label: 'Daftar Barang' },
                { id: 'add', icon: 'plus', label: 'Tambah Barang' },
                { id: 'transfer', icon: 'exchange-alt', label: 'Transfer' },
                { id: 'history', icon: 'history', label: 'Riwayat' },
                { id: 'purchases', icon: 'shopping-cart', label: 'Pembelian' },
                { id: 'cashbook', icon: 'book', label: 'Buku Kas' },
                { id: 'import', icon: 'file-import', label: 'Import' },
                { id: 'settings', icon: 'cog', label: 'Pengaturan' }
            ];
            
            if (loading) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-gradient-to-br from-neutral-50 to-neutral-100">
                        <div className="text-center">
                            <div className="w-20 h-20 bg-white rounded-3xl flex items-center justify-center mx-auto mb-6 shadow-large">
                                <Icon name="spinner" className="text-4xl text-primary-500 animate-spin" />
                            </div>
                            <h2 className="text-2xl font-black text-neutral-800 mb-2">Memuat Aplikasi</h2>
                            <p className="text-neutral-600">Mohon tunggu sebentar...</p>
                        </div>
                    </div>
                );
            }
            
            return (
                <div className="min-h-screen flex flex-col md:flex-row">
                    {toast && <Toast message={toast.message} type={toast.type} onClose={() => setToast(null)} />}
                    {showNotifications && <NotificationsModal isOpen={showNotifications} onClose={() => setShowNotifications(false)} activities={activities} />}
                    
                    <aside className={`fixed top-0 left-0 h-full z-50 w-80 bg-white border-r border-neutral-200 shadow-large transform transition-transform duration-300 ease-in-out md:translate-x-0 md:static ${isSidebarOpen ? 'translate-x-0' : '-translate-x-full'}`}>
                        <div className="p-8 pb-6 h-full flex flex-col">
                            <div className="flex items-center justify-between mb-10">
                                <div className="flex items-center gap-3">
                                    <div className={`w-12 h-12 rounded-2xl flex items-center justify-center text-white shadow-medium ${activeStoreId === 'all_stores' ? 'bg-gradient-to-br from-accent-500 to-accent-600' : 'bg-gradient-to-br from-primary-500 to-primary-600'}`}>
                                        <Icon name="shop" className="text-xl" />
                                    </div>
                                    <div className="relative">
                                        <button onClick={() => setShowStoreMenu(!showStoreMenu)} className="text-left group flex items-center gap-2 hover:bg-neutral-50 p-2 -ml-2 rounded-xl transition-colors">
                                            <div>
                                                <h1 className="font-black text-xl text-neutral-800 leading-none">{currentProfile.name}</h1>
                                                <p className="text-[9px] font-bold uppercase tracking-widest mt-1.5 text-neutral-400">Professional System</p>
                                            </div>
                                            <Icon name="chevron-down" className={`text-xs text-neutral-400 transition-transform ${showStoreMenu ? 'rotate-180' : ''}`} />
                                        </button>
                                        {showStoreMenu && (
                                            <div className="absolute top-full left-0 mt-2 w-64 bg-white rounded-2xl shadow-large border border-neutral-100 overflow-hidden fade-in z-[60]">
                                                <div className="p-3 border-b border-neutral-100 bg-neutral-50"><span className="text-[10px] font-bold text-neutral-500 uppercase px-2 tracking-wider">Pilih Profil Toko</span></div>
                                                <div className="max-h-52 overflow-y-auto">
                                                    {(settingsData.storeProfiles || [{id:'default', name: APP_NAME}]).map(profile => (
                                                        <button key={profile.id} onClick={() => handleSwitchStore(profile.id)} className={`w-full text-left px-5 py-3.5 text-sm font-bold flex items-center justify-between hover:bg-primary-50 transition-colors ${activeStoreId === profile.id ? 'text-primary-600 bg-primary-50' : 'text-neutral-700'}`}>
                                                            <span className="truncate">{profile.name}</span>{activeStoreId === profile.id && <Icon name="check" className="text-sm" />}
                                                        </button>
                                                    ))}
                                                    {(settingsData.storeProfiles && settingsData.storeProfiles.length > 1) && (
                                                        <button onClick={() => handleSwitchStore('all_stores')} className={`w-full text-left px-5 py-3.5 text-sm font-bold flex items-center justify-between hover:bg-accent-50 transition-colors border-t border-neutral-100 ${activeStoreId === 'all_stores' ? 'text-accent-600 bg-accent-50' : 'text-neutral-700'}`}>
                                                            <span className="truncate">Semua Toko (Gabungan)</span>{activeStoreId === 'all_stores' && <Icon name="check" className="text-sm" />}
                                                        </button>
                                                    )}
                                                </div>
                                                <button onClick={() => { setActiveTab('settings'); setShowStoreMenu(false); }} className="w-full text-left px-5 py-3 text-[10px] font-bold text-neutral-400 hover:bg-neutral-50 border-t border-neutral-100 tracking-wider">+ KELOLA TOKO DI PENGATURAN</button>
                                            </div>
                                        )}
                                    </div>
                                </div>
                                <button onClick={() => setIsSidebarOpen(false)} className="md:hidden text-neutral-400 hover:text-neutral-600 p-2 rounded-xl hover:bg-neutral-100 transition-all">
                                    <Icon name="xmark" className="text-xl" />
                                </button>
                            </div>
                            
                            <nav className="space-y-2 flex-1">
                                {menuItems.map(menu => (
                                    <button
                                        key={menu.id}
                                        onClick={(e) => handleNavClick(menu.id, e)}
                                        className={`sidebar-menu-item w-full flex items-center gap-4 px-5 py-4 rounded-2xl text-sm font-bold transition-all ${activeTab === menu.id ? 'active bg-gradient-to-r from-primary-500 to-primary-600 text-white shadow-medium' : 'text-neutral-600 hover:bg-neutral-100'}`}
                                    >
                                        <Icon name={menu.icon} className={`w-5 text-lg ${activeTab === menu.id ? 'text-white' : 'text-neutral-400'}`} />
                                        {menu.label}
                                    </button>
                                ))}
                            </nav>
                            
                            <div className="mt-auto pt-8 border-t border-neutral-200">
                                <p className="text-[10px] text-center text-neutral-400 font-semibold tracking-wider uppercase">Versi 25.13 - Professional Edition</p>
                            </div>
                        </div>
                    </aside>
                    
                    <main className="flex-1 md:ml-0 p-6 md:p-10 max-w-[1600px] mx-auto w-full">
                        <div className="md:hidden mb-6 flex items-center justify-between">
                            <div className="flex items-center gap-3">
                                <div className={`w-10 h-10 rounded-xl flex items-center justify-center text-white shadow-medium ${activeStoreId === 'all_stores' ? 'bg-gradient-to-br from-accent-500 to-accent-600' : 'bg-gradient-to-br from-primary-500 to-primary-600'}`}>
                                    <Icon name="shop" />
                                </div>
                                <h1 className="font-bold text-neutral-800 text-lg">{currentProfile.name}</h1>
                            </div>
                            <div className="flex items-center gap-2">
                                <button onClick={() => setShowNotifications(true)} className="w-11 h-11 bg-white rounded-xl text-neutral-600 font-bold shadow-soft border border-neutral-200 flex items-center justify-center hover:bg-neutral-50 transition-all">
                                    <Icon name="bell" className="text-primary-600" />
                                </button>
                                <button onClick={() => setIsSidebarOpen(true)} className="bg-white px-4 py-2.5 rounded-xl text-neutral-700 font-bold text-sm shadow-soft border border-neutral-200 flex items-center gap-2 hover:bg-neutral-50 transition-all">
                                    <Icon name="bars" className="text-primary-600" /> Menu
                                </button>
                            </div>
                        </div>

                        <div className="hidden md:flex justify-end mb-6">
                            <button onClick={() => setShowNotifications(true)} className="bg-white px-5 py-3 rounded-xl text-neutral-600 font-semibold text-sm shadow-soft border border-neutral-200 hover:bg-neutral-50 transition-all flex items-center gap-2">
                                <Icon name="bell" className="text-primary-600" /> Aktivitas
                            </button>
                        </div>

                        {activeTab === 'home' && (<DashboardView items={inventoryData} settings={settingsData} onShowLowStock={() => { setActiveTab('list'); setShowOnlyLowStock(true); }} />)}
                        {activeTab === 'cashier' && (<CashierView items={inventoryData} user={user} showToast={showToast} settings={settingsData} onGenerateImage={handleGenerateImage} currentProfile={currentProfile} />)}
                        {activeTab === 'transfer' && (<TransferView items={rawInventory} settings={settingsData} showToast={showToast} currentProfile={currentProfile} user={user} />)}
                        {activeTab === 'history' && (<HistoryView user={user} showToast={showToast} settings={settingsData} onGenerateImage={handleGenerateImage} currentProfile={currentProfile} />)}
                        {activeTab === 'purchases' && (<PurchaseView user={user} showToast={showToast} />)}
                        {activeTab === 'cashbook' && (<CashBookView user={user} currentProfile={currentProfile} showToast={showToast} />)}
                        {activeTab === 'list' && (<ListView items={inventoryData} loading={loading} settings={settingsData} searchQuery={searchQuery} setSearchQuery={setSearchQuery} showOnlyLowStock={showOnlyLowStock} setShowOnlyLowStock={setShowOnlyLowStock} selectedRacks={selectedRacks} setSelectedRacks={setSelectedRacks} uniqueRacksData={uniqueRacksData} onCopySuccess={showToast} onEdit={(item) => { setFormData({...item}); setEditingItem(item); setActiveTab('add'); }} onDelete={(item) => setDeleteModal({ show: true, item: item })} onDeleteRack={(rackName) => setDeleteRackModal({ show: true, rackName })} currentProfile={currentProfile} />)}
                        {activeTab === 'add' && (<FormView formData={formData} setFormData={setFormData} onSubmit={handleSubmit} isEditing={!!editingItem} submitting={submitting} onCancel={() => { setEditingItem(null); setFormData({name:'', qty:'', unit:'Pcs', exp:'', rack:'', price:'', minStock: ''}); setActiveTab('list'); }} currentProfile={currentProfile} />)}
                        {activeTab === 'import' && (<BulkImportView user={user} onImportComplete={(count) => { showToast(`${count} Barang berhasil diimport`); setActiveTab('list'); }} currentProfile={currentProfile} settings={settingsData} />)}
                        {activeTab === 'settings' && (<SettingsView settings={settingsData} onSave={handleSaveSettings} loading={submitting} />)}
                    </main>
                    
                    <ConfirmModal isOpen={deleteModal.show} title="Hapus Barang?" message={`"${deleteModal.item?.name}" akan dihapus permanen dari semua toko.`} onConfirm={handleDelete} onCancel={() => setDeleteModal({ show: false, item: null })} />
                    <ConfirmModal isOpen={deleteRackModal.show} title="Hapus Rak?" message={`Semua barang di Rak "${deleteRackModal.rackName}" akan di-reset lokasinya menjadi '-'.`} onConfirm={handleConfirmDeleteRack} onCancel={() => setDeleteRackModal({ show: false, rackName: null })} />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
